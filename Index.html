<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="UTF-8">
    <!-- Meta viewport otimizada para bloquear zoom indesejado e ajustar ao ecr√£ perfeitamente -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0, viewport-fit=cover">
    <title>Comfy Life</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    
    <!-- FontAwesome (Para o √≠cone oficial da Cannabis) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400..900;1,400..900&family=Plus+Jakarta+Sans:wght@200..800&display=swap');
        
        html, body {
            width: 100%;
            overflow-x: hidden; /* Impede o scroll lateral / zoom out for√ßado */
            font-family: 'Plus Jakarta Sans', sans-serif; 
            -webkit-tap-highlight-color: transparent;
        }
        
        .font-serif { font-family: 'Playfair Display', serif; }
        
        ::-webkit-scrollbar { display: none; }
        * { -ms-overflow-style: none; scrollbar-width: none; }
        
        .animate-in { animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes fadeIn { 
            from { opacity: 0; transform: translateY(15px); } 
            to { opacity: 1; transform: translateY(0); } 
        }

        /* CORRE√á√ÉO DEFINITIVA DO ZOOM IN NOS TELEM√ìVEIS (iOS/Android):
         * For√ßa os campos de texto a terem 16px para o navegador n√£o fazer zoom autom√°tico ao clicar.
         */
        @media screen and (max-width: 768px) {
            input, select, textarea {
                font-size: 16px !important;
            }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // --- SISTEMA DE CORES ---
        const getThemeColors = (isDark) => ({
            bg: isDark ? 'bg-[#1C1A19]' : 'bg-[#F9F6F0]',
            card: isDark ? 'bg-[#282624]' : 'bg-white',
            surface: isDark ? 'bg-[#32302D]' : 'bg-stone-50',
            surfaceHover: isDark ? 'hover:bg-[#3D3A36]' : 'hover:bg-stone-100',
            surfaceAlt: isDark ? 'bg-[#3D3A36]' : 'bg-stone-100',
            text: isDark ? 'text-[#D6D0C4]' : 'text-[#5C544E]',
            textStrong: isDark ? 'text-[#F0EBE1]' : 'text-stone-700',
            textMuted: isDark ? 'text-[#A39D93]' : 'text-stone-500',
            textLight: isDark ? 'text-[#8A847A]' : 'text-[#9A8F85]',
            iconMuted: isDark ? 'text-[#5A5550]' : 'text-stone-300',
            primary: isDark ? 'bg-[#384A41]' : 'bg-[#D2E0D9]',
            primaryText: isDark ? 'text-[#A5C2B3]' : 'text-[#4A6B5D]',
            accent: isDark ? 'bg-[#5C3C3A]' : 'bg-[#F3D8D6]',
            accentText: isDark ? 'text-[#DEAAA7]' : 'text-[#9C5A56]',
            yellow: isDark ? 'bg-[#4A3D1A]' : 'bg-[#FDF3D8]',
            yellowText: isDark ? 'text-[#E0BE63]' : 'text-[#B08922]',
            blue: isDark ? 'bg-[#2C3E4F]' : 'bg-[#D6E4F0]',
            blueText: isDark ? 'text-[#9CB8D4]' : 'text-[#4A6984]',
            purple: isDark ? 'bg-[#3D2C4A]' : 'bg-[#E5D9F2]',
            purpleText: isDark ? 'text-[#BCA3D4]' : 'text-[#7A5C8A]',
            orange: isDark ? 'bg-[#5A3A22]' : 'bg-[#FFE5D4]',
            orangeText: isDark ? 'text-[#ECA16A]' : 'text-[#C76A28]',
            greenCard: isDark ? 'bg-[#2A402A]' : 'bg-[#E0F0E0]',
            greenText: isDark ? 'text-[#7BB07B]' : 'text-[#3B7A3B]',
            teal: isDark ? 'bg-[#214040]' : 'bg-[#E0F0F0]',
            tealText: isDark ? 'text-[#5EB0B0]' : 'text-[#3B7A7A]',
            emerald: isDark ? 'bg-[#20402E]' : 'bg-[#E0F0E6]',
            emeraldText: isDark ? 'text-[#63B88A]' : 'text-[#3B7A55]',
            border: isDark ? 'border-[#3D3A36]' : 'border-[#EAE3D9]',
            bottomNav: isDark ? 'bg-[#282624]/90 border-[#3D3A36]' : 'bg-white/80 border-[#EAE3D9]',
            input: isDark ? 'bg-[#1C1A19] text-[#D6D0C4]' : 'bg-white text-stone-700',
            translucent: isDark ? 'bg-black/20' : 'bg-white/60',
            translucentStrong: isDark ? 'bg-black/40' : 'bg-white/70',
            notification: isDark ? 'bg-[#282624]/95 border-[#3D3A36]' : 'bg-white/95 border-stone-200',
            indigoCard: isDark ? 'bg-indigo-900/20 border-indigo-900/50' : 'bg-indigo-50/30 border-indigo-100',
            indigoText: isDark ? 'text-indigo-300' : 'text-indigo-900',
            blueCard: isDark ? 'bg-blue-900/20 border-blue-900/50' : 'bg-blue-50/30 border-blue-100',
            blueTextAlt: isDark ? 'text-blue-300' : 'text-blue-900',
            purpleCard: isDark ? 'bg-purple-900/20 border-purple-900/50' : 'bg-[#E5D9F2] bg-opacity-30 border-purple-100',
        });

        // --- DADOS E UTILIT√ÅRIOS ---
        const MOODS = [
            { id: 'awful', icon: 'ph-smiley-sad', color: 'text-red-400', label: 'P√©ssimo' },
            { id: 'bad', icon: 'ph-smiley-meh', color: 'text-orange-400', label: 'Triste' },
            { id: 'ok', icon: 'ph-smiley', color: 'text-yellow-500', label: 'Ok' },
            { id: 'good', icon: 'ph-heart', color: 'text-green-400', label: 'Bem' },
            { id: 'great', icon: 'ph-star', color: 'text-pink-400', label: '√ìtimo' },
        ];

        const SLEEP_QUALITIES = [
            { id: 'bad', label: 'ü•± Mau', val: 1 },
            { id: 'ok', label: 'üòå Ok', val: 2 },
            { id: 'good', label: 'üò¥ Bom', val: 3 },
            { id: 'great', label: 'ü§© Perfeito', val: 4 },
        ];

        const WEEKDAYS = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'S√°b'];
        const MONTHS = ['Janeiro', 'Fevereiro', 'Mar√ßo', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];

        const getTodayStr = () => {
            const d = new Date();
            return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
        };

        const formatTime = (date) => `${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;
        
        const formatDateVisual = (dateStr) => {
            const [y, m, d] = dateStr.split('-');
            const date = new Date(y, m - 1, d);
            return `${date.getDate()} de ${MONTHS[date.getMonth()]}, ${y}`;
        };

        // --- MOCK DATA ---
        const generateMockData = () => {
            const data = {};
            const today = new Date();
            for (let i = 30; i >= 0; i--) {
                const d = new Date(today); d.setDate(d.getDate() - i);
                const dateStr = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
                if (Math.random() < 0.1 && i !== 0) continue;

                data[dateStr] = {
                    moods: [{ time: '09:00', mood: MOODS[Math.floor(Math.random() * 5)].id }],
                    sleep: { hours: Math.floor(Math.random() * 4) + 5, quality: SLEEP_QUALITIES[Math.floor(Math.random() * 4)].id },
                    meds: { '1': Math.random() > 0.2 }, 
                    exercises: Math.random() > 0.5 ? [{ type: 'Caminhada', duration: 30, calories: 150 }] : [],
                    hobbies: Math.random() > 0.3 ? [{ type: 'Leitura', duration: 45 }] : [],
                    chores: Math.random() > 0.4 ? [{ type: 'Arrumar quarto', duration: 20 }] : [],
                    pets: Math.random() > 0.4 ? [{ type: 'Passear o c√£o', duration: 30 }] : [],
                    plants: Math.random() > 0.4 ? [{ type: 'Regar', duration: 10 }] : [],
                    cannabis: Math.floor(Math.random() * 3),
                    work: Math.random() > 0.4 ? { entry: '08:00', exit: '17:00', pause: 60, mood: MOODS[Math.floor(Math.random() * 5)].id } : null,
                };
            }
            return data;
        };

        const INITIAL_USERS_DB = {
            'teste': { 
                password: '123', 
                name: 'Visitante', 
                securityAnswer: 'maria',
                logs: generateMockData(), 
                medications: [{ id: '1', name: 'Vitamina C', time: '09:00' }] 
            }
        };

        // --- COMPONENTES UI ---
        const Button = ({ children, onClick, variant = 'primary', className = '', colors }) => {
            const variants = {
                primary: `${colors.primary} ${colors.primaryText} hover:brightness-110`,
                accent: `${colors.accent} ${colors.accentText} hover:brightness-110`,
                purple: `${colors.purple} ${colors.purpleText} hover:brightness-110`,
                blue: `${colors.blue} ${colors.blueText} hover:brightness-110`,
                orange: `${colors.orange} ${colors.orangeText} hover:brightness-110`,
                teal: `${colors.teal} ${colors.tealText} hover:brightness-110`,
                emerald: `${colors.emerald} ${colors.emeraldText} hover:brightness-110`,
                outline: `border-2 ${colors.border} ${colors.text} ${colors.surfaceHover}`,
            };
            return <button onClick={onClick} className={`px-4 py-2 rounded-2xl font-bold transition-all flex items-center justify-center gap-2 ${variants[variant]} ${className}`}>{children}</button>;
        };

        const Card = ({ children, className = '', colors }) => (
            <div className={`${colors.card} rounded-3xl p-6 shadow-sm border ${colors.border} transition-colors duration-300 ${className}`}>{children}</div>
        );

        // --- APP PRINCIPAL ---
        function App() {
            const [deferredPrompt, setDeferredPrompt] = useState(null);
            useEffect(() => {
                const handleBIP = (e) => { e.preventDefault(); setDeferredPrompt(e); };
                window.addEventListener('beforeinstallprompt', handleBIP);
                return () => window.removeEventListener('beforeinstallprompt', handleBIP);
            }, []);

            // Estados B√°sicos
            const [isDarkMode, setIsDarkMode] = useState(false);
            const colors = useMemo(() => getThemeColors(isDarkMode), [isDarkMode]);
            const toggleTheme = () => setIsDarkMode(!isDarkMode);

            const [usersDb, setUsersDb] = useState(INITIAL_USERS_DB);
            const [currentUsername, setCurrentUsername] = useState(null);

            const [authStep, setAuthStep] = useState('auth'); // auth, onboarding, recovery, app
            const [isLoginFlow, setIsLoginFlow] = useState(true);
            const [userName, setUserName] = useState('');
            const [usernameInput, setUsernameInput] = useState('');
            const [passwordInput, setPasswordInput] = useState('');
            const [securityAnswerInput, setSecurityAnswerInput] = useState('');

            const [activeTab, setActiveTab] = useState('home');
            const [realTodayStr, setRealTodayStr] = useState(getTodayStr());
            const [activeDateStr, setActiveDateStr] = useState(getTodayStr()); 
            
            const [logs, setLogs] = useState({});
            const [medications, setMedications] = useState([]);
            const [notifications, setNotifications] = useState([]);

            // Formul√°rios Di√°rio
            const [exerciseInput, setExerciseInput] = useState({ type: '', duration: '', calories: '' });
            const [hobbyInput, setHobbyInput] = useState({ type: '', duration: '' });
            const [choreInput, setChoreInput] = useState({ type: '', duration: '' });
            const [petInput, setPetInput] = useState({ type: '', duration: '' });
            const [plantInput, setPlantInput] = useState({ type: '', duration: '' });
            const [workInput, setWorkInput] = useState({ entry: '', exit: '', pause: 60, mood: 'ok' });
            const [isAddingMed, setIsAddingMed] = useState(false);
            const [newMedInput, setNewMedInput] = useState({ name: '', time: '08:00' });
            
            // Abas Info
            const [statsPeriod, setStatsPeriod] = useState(7);
            const [viewingMonth, setViewingMonth] = useState(new Date());
            const [selectedHistoryDate, setSelectedHistoryDate] = useState(getTodayStr());

            // DB Sync
            useEffect(() => {
                if (currentUsername && authStep === 'app') {
                    setUsersDb(prev => ({ ...prev, [currentUsername]: { ...prev[currentUsername], logs, medications } }));
                }
            }, [logs, medications, currentUsername, authStep]);

            const dayLog = logs[activeDateStr] || { moods: [], sleep: { hours: 0, quality: '' }, meds: {}, exercises: [], hobbies: [], chores: [], pets: [], plants: [], cannabis: 0, work: null };

            const updateActiveLog = (key, value) => {
                setLogs(prev => ({
                    ...prev, [activeDateStr]: { ...(prev[activeDateStr] || { moods: [], sleep: { hours: 0, quality: '' }, meds: {}, exercises: [], hobbies: [], chores: [], pets: [], plants: [], cannabis: 0, work: null }), [key]: value }
                }));
            };

            // Alarmes e Midnight
            useEffect(() => {
                const checkTime = setInterval(() => {
                    const today = getTodayStr();
                    if (today !== realTodayStr) {
                        setRealTodayStr(today);
                        if (activeDateStr === realTodayStr) setActiveDateStr(today); 
                    }
                    if (authStep === 'app') {
                        const timeStr = formatTime(new Date());
                        medications.forEach(med => {
                            if (med.time === timeStr && !logs[today]?.meds?.[med.id]) {
                                addNotification(`Hora de tomar: ${med.name}! üíä`);
                            }
                        });
                    }
                }, 60000);
                return () => clearInterval(checkTime);
            }, [medications, logs, realTodayStr, authStep, activeDateStr]);

            const addNotification = (msg) => {
                const id = Date.now();
                setNotifications(prev => [...prev, { id, msg }]);
                setTimeout(() => setNotifications(prev => prev.filter(n => n.id !== id)), 5000);
            };

            // Handlers Autentica√ß√£o
            const handleAuthSubmit = () => {
                if (!usernameInput || !passwordInput) return addNotification("Preencha utilizador e palavra-passe!");
                const userKey = usernameInput.toLowerCase().trim();
                
                if (isLoginFlow) {
                    const user = usersDb[userKey];
                    if (user && user.password === passwordInput) {
                        setCurrentUsername(userKey); 
                        setUserName(user.name);
                        setLogs(user.logs || {}); 
                        setMedications(user.medications || []);
                        setActiveDateStr(getTodayStr()); 
                        setAuthStep('app'); 
                        setActiveTab('home');
                    } else {
                        addNotification("Utilizador ou palavra-passe incorretos!");
                    }
                } else {
                    if (usersDb[userKey]) return addNotification("Este utilizador j√° existe!");
                    setLogs({}); 
                    setMedications([]); 
                    setSecurityAnswerInput(''); 
                    setAuthStep('onboarding');
                }
            };

            const handleOnboardingSubmit = () => {
                if (!userName.trim() || !securityAnswerInput.trim()) return addNotification("Por favor, preencha todos os campos!");
                const userKey = usernameInput.toLowerCase().trim();
                
                setUsersDb(prev => ({ 
                    ...prev, 
                    [userKey]: { 
                        password: passwordInput, 
                        name: userName.trim(), 
                        securityAnswer: securityAnswerInput.toLowerCase().trim(),
                        logs: {}, 
                        medications: [] 
                    } 
                }));
                setCurrentUsername(userKey); 
                setAuthStep('app'); 
                setActiveTab('home');
            };

            const handleRecoverySubmit = () => {
                if (!usernameInput || !securityAnswerInput) return addNotification("Preencha o utilizador e a resposta secreta!");
                const userKey = usernameInput.toLowerCase().trim();
                const user = usersDb[userKey];
                
                if (user && user.securityAnswer === securityAnswerInput.toLowerCase().trim()) {
                    addNotification(`A sua palavra-passe √©: ${user.password}`);
                    setTimeout(() => setAuthStep('auth'), 3000); 
                } else {
                    addNotification("Utilizador ou resposta secreta incorretos.");
                }
            };

            const handleLogout = () => {
                // Voltar sempre para a aba de Login Flow ao fazer logout
                setAuthStep('auth'); 
                setIsLoginFlow(true); 
                
                setCurrentUsername(null); 
                setUserName('');
                setUsernameInput(''); 
                setPasswordInput(''); 
                setSecurityAnswerInput('');
                
                setLogs({}); 
                setMedications([]);
                setActiveDateStr(getTodayStr());
                
                // Limpar todos os inputs di√°rios para o pr√≥ximo utilizador
                setExerciseInput({ type: '', duration: '', calories: '' });
                setHobbyInput({ type: '', duration: '' });
                setChoreInput({ type: '', duration: '' });
                setPetInput({ type: '', duration: '' });
                setPlantInput({ type: '', duration: '' });
                setWorkInput({ entry: '', exit: '', pause: 60, mood: 'ok' });
                setNewMedInput({ name: '', time: '08:00' });
                setIsAddingMed(false);
            };

            // Handlers Di√°rio
            const handleAddMedication = () => {
                if (newMedInput.name && newMedInput.time) {
                    setMedications([...medications, { id: Date.now().toString(), name: newMedInput.name, time: newMedInput.time }]);
                    setNewMedInput({ name: '', time: '08:00' }); setIsAddingMed(false);
                } else addNotification("Preencha o nome e a hora do rem√©dio!");
            };

            // Estat√≠sticas Processamento
            const stats = useMemo(() => {
                const today = new Date();
                let totalSleep = 0, sleepDays = 0, medTaken = 0, medTotal = 0;
                let totalExMins = 0, totalExCals = 0, totalHobbyMins = 0, totalWorkMins = 0;
                let totalChoresMins = 0, totalPetsMins = 0, totalPlantsMins = 0, totalCannabis = 0;
                const moodCounts = {}, workMoodCounts = {};

                for (let i = 0; i < statsPeriod; i++) {
                    const d = new Date(today); d.setDate(d.getDate() - i);
                    const dateStr = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
                    const l = logs[dateStr];

                    if (l) {
                        if (l.sleep?.hours) { totalSleep += l.sleep.hours; sleepDays++; }
                        medications.forEach(med => { medTotal++; if (l.meds?.[med.id]) medTaken++; });
                        l.exercises?.forEach(ex => { totalExMins += ex.duration; totalExCals += (ex.calories || 0); });
                        l.hobbies?.forEach(hb => { totalHobbyMins += hb.duration; });
                        l.chores?.forEach(ch => { totalChoresMins += ch.duration; });
                        l.pets?.forEach(p => { totalPetsMins += p.duration; });
                        l.plants?.forEach(p => { totalPlantsMins += p.duration; });
                        totalCannabis += (l.cannabis || 0);

                        if (l.work?.entry && l.work?.exit) {
                            const [eH, eM] = l.work.entry.split(':').map(Number);
                            const [xH, xM] = l.work.exit.split(':').map(Number);
                            const pause = l.work.pause || 0;
                            let mins = (xH * 60 + xM) - (eH * 60 + eM) - pause;
                            if (mins < 0) mins += 24 * 60;
                            totalWorkMins += Math.max(0, mins);
                            
                            if (l.work.mood) workMoodCounts[l.work.mood] = (workMoodCounts[l.work.mood] || 0) + 1;
                        }
                        l.moods?.forEach(m => { moodCounts[m.mood] = (moodCounts[m.mood] || 0) + 1; });
                    }
                }

                const avgSleep = sleepDays ? (totalSleep / sleepDays).toFixed(1) : 0;
                const medAdherence = medTotal ? Math.round((medTaken / medTotal) * 100) : 0;
                const topMoodId = Object.keys(moodCounts).sort((a,b) => moodCounts[b] - moodCounts[a])[0];
                const topMood = MOODS.find(m => m.id === topMoodId) || MOODS[2];
                
                const topWorkMoodId = Object.keys(workMoodCounts).sort((a,b) => workMoodCounts[b] - workMoodCounts[a])[0];
                const topWorkMood = MOODS.find(m => m.id === topWorkMoodId) || null;

                return { avgSleep, medAdherence, totalExMins, totalExCals, totalHobbyMins, totalChoresMins, totalPetsMins, totalPlantsMins, totalWorkMins, totalCannabis, topMood, topWorkMood };
            }, [statsPeriod, logs, medications]);

            // Calend√°rio UI Vari√°veis
            const currentYear = viewingMonth.getFullYear();
            const currentMonthIndex = viewingMonth.getMonth();
            const daysInMonth = new Date(currentYear, currentMonthIndex + 1, 0).getDate();
            const firstDayOfWeek = new Date(currentYear, currentMonthIndex, 1).getDay();
            const blanks = Array.from({ length: firstDayOfWeek }, (_, i) => i);
            const monthDays = Array.from({ length: daysInMonth }, (_, i) => i + 1);

            // --- TELAS AUTH ---
            if (authStep === 'auth') {
                return (
                    <div className={`min-h-screen w-full ${colors.bg} flex items-center justify-center p-4 transition-colors overflow-hidden`}>
                        <div className={`max-w-md w-full relative ${colors.bg} shadow-2xl flex flex-col rounded-[2.5rem] border ${colors.border}`}>
                            <div className="p-8 flex flex-col items-center text-center space-y-6">
                                <div className="flex w-full justify-end items-center absolute top-6 right-6">
                                    <button onClick={toggleTheme} className={`${colors.yellow} p-3 rounded-full shadow-sm`}>
                                        <i className={`ph-fill ${isDarkMode ? 'ph-moon' : 'ph-sun'} ${colors.yellowText} text-xl`}></i>
                                    </button>
                                </div>
                                <div className="mt-12">
                                    <i className={`ph-fill ph-heart ${colors.accentText} text-5xl mx-auto mb-4 block`}></i>
                                    <h1 className={`text-3xl font-bold ${colors.text} font-serif`}>Comfy Life</h1>
                                    <p className={`text-sm ${colors.textLight} mt-2`}>O seu espa√ßo seguro e interativo.</p>
                                </div>
                                <div className="w-full space-y-4 mt-8">
                                    <div className={`flex items-center ${colors.card} px-4 py-3 rounded-2xl border ${colors.border}`}>
                                        <i className={`ph-fill ph-user ${colors.textLight} text-xl`}></i>
                                        <input type="text" placeholder="Utilizador" value={usernameInput} onChange={e => setUsernameInput(e.target.value)} className={`w-full ml-3 border-none outline-none bg-transparent ${colors.textStrong}`} />
                                    </div>
                                    <div className={`flex items-center ${colors.card} px-4 py-3 rounded-2xl border ${colors.border}`}>
                                        <i className={`ph-fill ph-lock-key ${colors.textLight} text-xl`}></i>
                                        <input type="password" placeholder="Palavra-passe" value={passwordInput} onChange={e => setPasswordInput(e.target.value)} className={`w-full ml-3 border-none outline-none bg-transparent ${colors.textStrong}`} />
                                    </div>
                                </div>
                                <Button colors={colors} variant="primary" onClick={handleAuthSubmit} className="w-full py-3 mt-4 text-lg">{isLoginFlow ? 'Entrar' : 'Criar Conta'}</Button>
                                
                                <div className="flex flex-col items-center gap-2 mt-4">
                                    <button 
                                        onClick={() => {
                                            setIsLoginFlow(!isLoginFlow);
                                            setUsernameInput('');
                                            setPasswordInput('');
                                        }} 
                                        className={`text-sm font-medium ${colors.textLight}`}
                                    >
                                        {isLoginFlow ? 'N√£o tem uma conta? Cadastre-se' : 'J√° tem uma conta? Iniciar Sess√£o'}
                                    </button>
                                    
                                    {isLoginFlow && (
                                        <button onClick={() => {
                                            setAuthStep('recovery');
                                            setUsernameInput('');
                                            setPasswordInput('');
                                        }} className={`text-xs font-bold ${colors.primaryText} hover:underline`}>
                                            Esqueceu a palavra-passe?
                                        </button>
                                    )}
                                </div>
                                
                                {isLoginFlow && <p className={`text-xs ${colors.textMuted} mt-4 opacity-70`}>Dica: teste / 123</p>}
                            </div>
                        </div>
                        <div className="absolute top-4 w-full px-4 z-50 flex flex-col gap-2 pointer-events-none max-w-md mx-auto">
                            {notifications.map(n => (
                                <div key={n.id} className={`${colors.notification} p-4 rounded-2xl flex items-center shadow-lg pointer-events-auto border`}><i className="ph-fill ph-bell text-blue-500 mr-2"></i><p className={`font-bold ${colors.textStrong} text-sm`}>{n.msg}</p></div>
                            ))}
                        </div>
                    </div>
                );
            }

            if (authStep === 'onboarding') {
                return (
                    <div className={`min-h-screen w-full ${colors.bg} flex items-center justify-center p-4 transition-colors overflow-hidden`}>
                        <div className={`max-w-md w-full relative ${colors.bg} shadow-2xl flex flex-col rounded-[2.5rem] border ${colors.border} p-8 text-center`}>
                            <i className={`ph-fill ph-smiley ${colors.primaryText} text-4xl mb-4 bg-[#D2E0D9] p-4 rounded-full inline-block`}></i>
                            <h1 className={`text-2xl font-bold ${colors.text} font-serif`}>Como podemos trat√°-lo(a)?</h1>
                            
                            <div className="space-y-4 mt-8">
                                <div className={`flex items-center ${colors.card} px-4 py-3 rounded-2xl border ${colors.border}`}>
                                    <i className={`ph-fill ph-user ${colors.textLight} text-xl`}></i>
                                    <input type="text" placeholder="O seu nome (ex: Jo√£o)" value={userName} onChange={e => setUserName(e.target.value)} className={`w-full ml-3 border-none outline-none bg-transparent ${colors.textStrong}`} />
                                </div>
                                
                                <div className="text-left pt-2 pb-1">
                                    <label className={`text-sm font-bold ${colors.textMuted} ml-2`}>Pergunta de seguran√ßa para recuperar senha:</label>
                                </div>
                                <div className={`flex items-center ${colors.card} px-4 py-3 rounded-2xl border ${colors.border}`}>
                                    <i className={`ph-fill ph-shield-check ${colors.textLight} text-xl`}></i>
                                    <input type="text" placeholder="Qual o nome da sua av√≥?" value={securityAnswerInput} onChange={e => setSecurityAnswerInput(e.target.value)} className={`w-full ml-3 border-none outline-none bg-transparent ${colors.textStrong}`} />
                                </div>
                            </div>
                            
                            <Button colors={colors} variant="primary" onClick={handleOnboardingSubmit} className="w-full py-3 mt-8 text-lg">Concluir e Come√ßar</Button>
                        </div>
                        <div className="absolute top-4 w-full px-4 z-50 flex flex-col gap-2 pointer-events-none max-w-md mx-auto">
                            {notifications.map(n => (
                                <div key={n.id} className={`${colors.notification} p-4 rounded-2xl flex items-center shadow-lg pointer-events-auto border`}><i className="ph-fill ph-bell text-blue-500 mr-2"></i><p className={`font-bold ${colors.textStrong} text-sm`}>{n.msg}</p></div>
                            ))}
                        </div>
                    </div>
                );
            }

            if (authStep === 'recovery') {
                return (
                    <div className={`min-h-screen w-full ${colors.bg} flex items-center justify-center p-4 transition-colors overflow-hidden`}>
                        <div className={`max-w-md w-full relative ${colors.bg} shadow-2xl flex flex-col rounded-[2.5rem] border ${colors.border} p-8 text-center`}>
                            <button onClick={() => {
                                setAuthStep('auth');
                                setUsernameInput('');
                                setSecurityAnswerInput('');
                            }} className={`absolute top-6 left-6 ${colors.textLight} hover:${colors.textStrong}`}>
                                <i className="ph-bold ph-arrow-left text-xl"></i>
                            </button>
                            <i className={`ph-fill ph-lock-key ${colors.primaryText} text-4xl mb-4 mt-4 bg-[#D2E0D9] p-4 rounded-full inline-block mx-auto`}></i>
                            <h1 className={`text-2xl font-bold ${colors.text} font-serif mb-6`}>Recuperar Palavra-passe</h1>
                            
                            <div className="space-y-4">
                                <div className={`flex items-center ${colors.card} px-4 py-3 rounded-2xl border ${colors.border}`}>
                                    <i className={`ph-fill ph-user ${colors.textLight} text-xl`}></i>
                                    <input type="text" placeholder="O seu Utilizador" value={usernameInput} onChange={e => setUsernameInput(e.target.value)} className={`w-full ml-3 border-none outline-none bg-transparent ${colors.textStrong}`} />
                                </div>
                                <div className="text-left mt-4 mb-2">
                                    <label className={`text-sm font-bold ${colors.textMuted} ml-2`}>Qual o nome da sua av√≥?</label>
                                </div>
                                <div className={`flex items-center ${colors.card} px-4 py-3 rounded-2xl border ${colors.border}`}>
                                    <i className={`ph-fill ph-question ${colors.textLight} text-xl`}></i>
                                    <input type="text" placeholder="A sua resposta secreta" value={securityAnswerInput} onChange={e => setSecurityAnswerInput(e.target.value)} className={`w-full ml-3 border-none outline-none bg-transparent ${colors.textStrong}`} />
                                </div>
                            </div>
                            
                            <Button colors={colors} variant="primary" onClick={handleRecoverySubmit} className="w-full py-3 mt-8 text-lg">Recuperar</Button>
                        </div>
                        
                        <div className="absolute top-4 w-full px-4 z-50 flex flex-col gap-2 pointer-events-none max-w-md mx-auto">
                            {notifications.map(n => (
                                <div key={n.id} className={`${colors.notification} p-4 rounded-2xl flex items-center shadow-lg pointer-events-auto border`}><i className="ph-fill ph-bell text-blue-500 mr-2"></i><p className={`font-bold ${colors.textStrong} text-sm`}>{n.msg}</p></div>
                            ))}
                        </div>
                    </div>
                );
            }

            // --- APP ---
            return (
                <div className={`min-h-screen w-full ${colors.bg} transition-colors duration-500 overflow-hidden`}>
                    <div className={`max-w-md mx-auto min-h-screen relative ${colors.bg} flex flex-col`}>
                        <div className="flex-1 overflow-y-auto p-6 scrollbar-hide pb-36">
                            
                            {/* Header Global (Fixo em todas as abas) */}
                            <div className="flex justify-between items-start mb-6">
                                <div className="flex-1">
                                    {activeTab === 'home' && (
                                        <>
                                            <p className={`text-xs ${colors.textLight} uppercase tracking-widest`}>{formatDateVisual(activeDateStr)}</p>
                                            <h1 className={`text-2xl font-bold ${colors.text} font-serif mt-1`}>
                                                {activeDateStr === realTodayStr ? `Ol√°, ${userName}!` : 'Edi√ß√£o de Registo'}
                                            </h1>
                                            {activeDateStr !== realTodayStr && (
                                                <button onClick={() => setActiveDateStr(realTodayStr)} className={`text-xs ${colors.primaryText} font-bold mt-1 flex items-center gap-1`}><i className="ph-bold ph-arrow-left"></i> Voltar para Hoje</button>
                                            )}
                                        </>
                                    )}
                                    {activeTab === 'calendar' && <h1 className={`text-3xl font-bold ${colors.text} font-serif mt-1`}>Hist√≥rico</h1>}
                                    {activeTab === 'stats' && <h1 className={`text-3xl font-bold ${colors.text} font-serif mt-1`}>Estat√≠sticas</h1>}
                                </div>
                                <div className="flex items-center gap-2 ml-4">
                                    {deferredPrompt && (
                                        <button onClick={handleInstallApp} className={`${colors.primary} ${colors.primaryText} p-3 rounded-full shadow-sm`}><i className="ph-bold ph-download-simple text-xl"></i></button>
                                    )}
                                    <button onClick={toggleTheme} className={`${colors.yellow} p-3 rounded-full shadow-sm`}><i className={`ph-fill ${isDarkMode ? 'ph-moon' : 'ph-sun'} ${colors.yellowText} text-xl`}></i></button>
                                    <button onClick={handleLogout} className={`${colors.card} border ${colors.border} p-3 rounded-full text-red-400 shadow-sm`}><i className="ph-bold ph-sign-out text-xl"></i></button>
                                </div>
                            </div>

                            {/* --- HOME (DI√ÅRIO) --- */}
                            {activeTab === 'home' && (
                                <div className="space-y-6 animate-in">

                                    {/* Humor */}
                                    <Card colors={colors}>
                                        <div className="flex items-center gap-2 mb-4">
                                            <i className={`ph-fill ph-heart ${colors.accentText} text-xl`}></i>
                                            <h3 className={`font-semibold ${colors.text}`}>Humor</h3>
                                        </div>
                                        <div className={`flex justify-between items-center ${colors.surface} p-4 rounded-2xl mb-4`}>
                                            {MOODS.map(m => (
                                                <button key={m.id} onClick={() => updateActiveLog('moods', [...dayLog.moods, {time: formatTime(new Date()), mood: m.id}])} className={`hover:scale-110 transition-transform ${m.color}`}>
                                                    <i className={`ph-fill ${m.icon} text-4xl`}></i>
                                                </button>
                                            ))}
                                        </div>
                                        {dayLog.moods.length > 0 && (
                                            <div className="flex flex-wrap gap-2">
                                                {dayLog.moods.map((m, i) => {
                                                    const moodData = MOODS.find(x => x.id === m.mood);
                                                    return (
                                                        <div key={i} className={`flex items-center gap-1 ${colors.surfaceAlt} px-3 py-1.5 rounded-full text-sm`}>
                                                            <i className={`ph-fill ${moodData.icon} ${moodData.color}`}></i>
                                                            <span className={`font-medium ${colors.textLight}`}>{m.time}</span>
                                                            <button onClick={() => updateActiveLog('moods', dayLog.moods.filter((_, idx) => idx !== i))} className="ml-1 text-red-400"><i className="ph-bold ph-x text-xs"></i></button>
                                                        </div>
                                                    );
                                                })}
                                            </div>
                                        )}
                                    </Card>

                                    {/* Medica√ß√£o */}
                                    <Card colors={colors}>
                                        <div className="flex items-center justify-between mb-4">
                                            <div className="flex items-center gap-2"><i className={`ph-fill ph-pill ${colors.blueText} text-xl`}></i><h3 className={`font-semibold ${colors.text}`}>Medica√ß√£o</h3></div>
                                            <button onClick={() => setIsAddingMed(!isAddingMed)} className={`p-1.5 rounded-full ${colors.blue} ${colors.blueText}`}><i className={`ph-bold ${isAddingMed ? 'ph-x' : 'ph-plus'} text-lg`}></i></button>
                                        </div>
                                        {isAddingMed && (
                                            <div className={`${colors.blueCard} p-4 rounded-2xl mb-4 space-y-3 border`}>
                                                <div className="flex gap-2">
                                                    <input placeholder="Nome da medica√ß√£o" value={newMedInput.name} onChange={e => setNewMedInput({...newMedInput, name: e.target.value})} className={`flex-1 min-w-0 px-4 py-2 rounded-xl text-sm ${colors.input}`} />
                                                    <input type="time" value={newMedInput.time} onChange={e => setNewMedInput({...newMedInput, time: e.target.value})} className={`w-24 shrink-0 px-2 py-2 text-center rounded-xl text-sm ${colors.input}`} />
                                                </div>
                                                <Button colors={colors} variant="blue" onClick={handleAddMedication} className="w-full py-2">Guardar Medica√ß√£o</Button>
                                            </div>
                                        )}
                                        <div className="space-y-3">
                                            {medications.map(med => {
                                                const isTaken = dayLog.meds?.[med.id];
                                                return (
                                                    <div key={med.id} className={`flex items-center justify-between p-3 rounded-2xl border ${isTaken ? `${colors.primary} border-transparent` : `${colors.surface} ${colors.border}`}`}>
                                                        <div className="flex items-center gap-3">
                                                            <div className={`p-2 rounded-full ${isTaken ? `${colors.translucent} ${colors.primaryText}` : `${colors.card} ${colors.iconMuted}`}`}><i className="ph-fill ph-clock text-lg"></i></div>
                                                            <div><p className={`font-bold ${isTaken ? colors.primaryText : colors.textStrong} text-sm`}>{med.name}</p><p className={`text-xs ${isTaken ? colors.primaryText : colors.textLight}`}>{med.time}</p></div>
                                                        </div>
                                                        <div className="flex gap-2">
                                                            <button onClick={() => setMedications(medications.filter(m => m.id !== med.id))} className="text-red-400 p-2"><i className="ph-bold ph-x text-sm"></i></button>
                                                            <button onClick={() => { const m = {...(dayLog.meds || {})}; m[med.id] = !m[med.id]; updateActiveLog('meds', m); }} className={`w-10 h-10 rounded-full flex items-center justify-center border-2 ${isTaken ? `${colors.card} ${colors.primaryText} border-transparent` : `${colors.border} text-transparent`}`}>
                                                                <i className="ph-bold ph-check text-xl"></i>
                                                            </button>
                                                        </div>
                                                    </div>
                                                )
                                            })}
                                        </div>
                                    </Card>

                                    {/* Sono */}
                                    <Card colors={colors}>
                                        <div className="flex items-center gap-2 mb-4"><i className="ph-fill ph-moon text-indigo-400 text-xl"></i><h3 className={`font-semibold ${colors.text}`}>Sono</h3></div>
                                        <div className="space-y-4">
                                            <div>
                                                <label className={`text-sm ${colors.textLight} mb-2 block`}>Horas: <span className={`font-bold ${colors.indigoText}`}>{Number(dayLog.sleep?.hours || 0).toFixed(1).replace('.0', '')}h</span></label>
                                                <input type="range" min="0" max="14" step="0.1" value={dayLog.sleep?.hours || 0} onChange={(e) => updateActiveLog('sleep', { hours: parseFloat(e.target.value), quality: dayLog.sleep?.quality })} className="w-full accent-indigo-400" />
                                            </div>
                                            <div className="flex gap-2">
                                                {SLEEP_QUALITIES.map(q => (
                                                    <button key={q.id} onClick={() => updateActiveLog('sleep', { hours: dayLog.sleep?.hours || 0, quality: q.id })} className={`flex-1 py-2 rounded-xl text-xs font-bold ${dayLog.sleep?.quality === q.id ? 'bg-indigo-500/20 text-indigo-400' : `${colors.surface} ${colors.text}`}`}>{q.label}</button>
                                                ))}
                                            </div>
                                        </div>
                                    </Card>

                                    {/* Cannabis Counter */}
                                    <Card colors={colors} className={`flex justify-between items-center ${colors.greenCard} bg-opacity-20 border-green-200`}>
                                        <div className="flex items-center gap-2">
                                            <i className="fa-solid fa-cannabis text-green-500 text-3xl"></i>
                                            <h3 className={`font-semibold ${colors.textStrong}`}>Consumo</h3>
                                        </div>
                                        <div className={`flex items-center gap-4 ${colors.translucentStrong} p-2 rounded-2xl`}>
                                            <button onClick={() => updateActiveLog('cannabis', Math.max(0, (dayLog.cannabis || 0) - 1))} className={`${colors.textMuted} hover:text-red-500`}><i className="ph-bold ph-prohibit text-2xl"></i></button>
                                            <span className={`font-bold text-2xl ${colors.greenText}`}>{dayLog.cannabis || 0}</span>
                                            <button onClick={() => updateActiveLog('cannabis', (dayLog.cannabis || 0) + 1)} className={`${colors.textMuted} hover:text-orange-500`}><i className="ph-fill ph-fire text-2xl"></i></button>
                                        </div>
                                    </Card>

                                    {/* Trabalho OTIMIZADO */}
                                    <Card colors={colors} className={`${colors.purple} bg-opacity-20`}>
                                        <div className="flex items-center gap-2 mb-4"><i className={`ph-fill ph-briefcase ${colors.purpleText} text-xl`}></i><h3 className={`font-semibold ${colors.text}`}>Trabalho</h3></div>
                                        {dayLog.work ? (
                                            <div className={`${colors.translucentStrong} p-4 rounded-xl shadow-sm`}>
                                                <div className="flex justify-between items-center mb-2">
                                                    <div><p className={`text-xs ${colors.textMuted}`}>Turno</p><p className={`font-bold ${colors.textStrong}`}>{dayLog.work.entry} - {dayLog.work.exit}</p></div>
                                                    <div><p className={`text-xs ${colors.textMuted}`}>Pausa</p><p className={`font-bold ${colors.textStrong}`}>{dayLog.work.pause}m</p></div>
                                                </div>
                                                <div className="flex justify-between items-center border-t border-purple-200 pt-3 mt-3">
                                                    <span className={`${MOODS.find(m => m.id === dayLog.work.mood)?.color} flex items-center gap-1 text-sm font-bold`}><i className={`ph-fill ${MOODS.find(m => m.id === dayLog.work.mood)?.icon} text-xl`}></i> Humor</span>
                                                    <div className="flex gap-3">
                                                        <button onClick={() => { setWorkInput(dayLog.work); updateActiveLog('work', null); }} className="text-blue-500 text-sm flex items-center gap-1"><i className="ph-bold ph-pencil-simple"></i> Editar</button>
                                                        <button onClick={() => updateActiveLog('work', null)} className="text-red-400 text-sm flex items-center gap-1"><i className="ph-bold ph-trash"></i> Remover</button>
                                                    </div>
                                                </div>
                                            </div>
                                        ) : (
                                            <div className="space-y-4">
                                                <div className="flex gap-4 justify-center">
                                                    <div className="w-1/3">
                                                        <label className={`text-[10px] uppercase font-bold ${colors.textMuted} mb-1 block text-center`}>Entrada</label>
                                                        <input type="time" value={workInput.entry} onChange={e => setWorkInput({...workInput, entry: e.target.value})} className={`w-full p-2 text-center rounded-xl ${colors.input}`} />
                                                    </div>
                                                    <div className="w-1/3">
                                                        <label className={`text-[10px] uppercase font-bold ${colors.textMuted} mb-1 block text-center`}>Sa√≠da</label>
                                                        <input type="time" value={workInput.exit} onChange={e => setWorkInput({...workInput, exit: e.target.value})} className={`w-full p-2 text-center rounded-xl ${colors.input}`} />
                                                    </div>
                                                </div>
                                                <div className="flex flex-col items-center">
                                                    <label className={`text-[10px] uppercase font-bold ${colors.textMuted} mb-1 block text-center`}>Intervalo / Pausa (min)</label>
                                                    <input type="number" placeholder="Ex: 60" value={workInput.pause} onChange={e => setWorkInput({...workInput, pause: parseInt(e.target.value)||0})} className={`w-24 p-2 text-center rounded-xl ${colors.input}`} />
                                                </div>
                                                <div>
                                                    <label className={`text-xs ${colors.textMuted} mb-2 block text-center`}>Humor no expediente</label>
                                                    <div className={`flex justify-between items-center ${colors.card} p-2 rounded-xl`}>
                                                        {MOODS.map(m => (
                                                            <button key={m.id} onClick={() => setWorkInput({...workInput, mood: m.id})} className={`p-1.5 rounded-full ${workInput.mood === m.id ? `${colors.surface} shadow-sm ${m.color}` : 'opacity-40 grayscale'}`}><i className={`ph-fill ${m.icon} text-3xl`}></i></button>
                                                        ))}
                                                    </div>
                                                </div>
                                                <Button colors={colors} variant="purple" onClick={() => { if (workInput.entry && workInput.exit) { updateActiveLog('work', workInput); setWorkInput({ entry: '', exit: '', pause: 60, mood: 'ok' }); } }} className="w-full">Salvar Expediente</Button>
                                            </div>
                                        )}
                                    </Card>

                                    {/* Casa, Pets, Plantas, Exerc√≠cio, Hobby */}
                                    <div className="space-y-4">
                                        {/* Tarefas Dom√©sticas */}
                                        <Card colors={colors} className={`${colors.orange} bg-opacity-20 p-5`}>
                                            <div className="flex items-center gap-2 mb-4"><i className={`ph-fill ph-broom ${colors.orangeText} text-xl`}></i><h3 className={`font-semibold ${colors.text}`}>Servi√ßos Dom√©sticos</h3></div>
                                            <div className="flex gap-2 mb-4">
                                                <input placeholder="Ex: Lavar loi√ßa" value={choreInput.type} onChange={e => setChoreInput({...choreInput, type: e.target.value})} className={`flex-1 min-w-0 p-2 rounded-lg ${colors.input}`} />
                                                <input type="number" placeholder="Min" value={choreInput.duration} onChange={e => setChoreInput({...choreInput, duration: e.target.value})} className={`w-16 shrink-0 p-2 rounded-lg text-center ${colors.input}`} />
                                                <button onClick={() => { if(choreInput.type && choreInput.duration) { updateActiveLog('chores', [...dayLog.chores, {type: choreInput.type, duration: parseInt(choreInput.duration)}]); setChoreInput({type:'',duration:''}); } }} className={`${colors.orange} ${colors.orangeText} px-3 rounded-lg font-bold shrink-0`}><i className="ph-bold ph-plus"></i></button>
                                            </div>
                                            {dayLog.chores?.map((ch, i) => (
                                                <div key={i} className={`flex justify-between items-center ${colors.translucentStrong} p-2 rounded-lg text-sm mt-2`}><span className={colors.textStrong}>{ch.type}</span><div className="flex items-center gap-3"><span className={`text-xs ${colors.textMuted}`}>{ch.duration}m</span><button onClick={() => updateActiveLog('chores', dayLog.chores.filter((_, idx) => idx !== i))} className="text-red-400 shrink-0"><i className="ph-bold ph-x"></i></button></div></div>
                                            ))}
                                        </Card>

                                        <div className="grid grid-cols-2 gap-4">
                                            {/* Pets */}
                                            <Card colors={colors} className={`${colors.teal} bg-opacity-20 p-4`}>
                                                <div className="flex items-center gap-2 mb-3"><i className={`ph-fill ph-paw-print ${colors.tealText}`}></i><h3 className={`font-semibold text-sm ${colors.text}`}>Pets</h3></div>
                                                <div className="space-y-2 mb-3">
                                                    <input placeholder="Ex: Passeio" value={petInput.type} onChange={e => setPetInput({...petInput, type: e.target.value})} className={`w-full p-2 rounded-lg ${colors.input}`} />
                                                    <input type="number" placeholder="Minutos" value={petInput.duration} onChange={e => setPetInput({...petInput, duration: e.target.value})} className={`w-full p-2 rounded-lg text-center ${colors.input}`} />
                                                    <Button colors={colors} variant="teal" onClick={() => { if(petInput.type && petInput.duration) { updateActiveLog('pets', [...dayLog.pets, {type: petInput.type, duration: parseInt(petInput.duration)}]); setPetInput({type:'',duration:''}); } }} className="w-full text-xs py-1.5">Salvar</Button>
                                                </div>
                                                {dayLog.pets?.map((p, i) => <div key={i} className={`flex justify-between items-center ${colors.translucent} p-2 rounded-lg text-xs mt-1`}><span className={`truncate mr-1 ${colors.textStrong}`}>{p.type}</span><button onClick={() => updateActiveLog('pets', dayLog.pets.filter((_, idx) => idx !== i))} className="text-red-400 shrink-0"><i className="ph-bold ph-x"></i></button></div>)}
                                            </Card>

                                            {/* Plantas */}
                                            <Card colors={colors} className={`${colors.emerald} bg-opacity-20 p-4`}>
                                                <div className="flex items-center gap-2 mb-3"><i className={`ph-fill ph-potted-plant ${colors.emeraldText}`}></i><h3 className={`font-semibold text-sm ${colors.text}`}>Plantas</h3></div>
                                                <div className="space-y-2 mb-3">
                                                    <input placeholder="Ex: Regar" value={plantInput.type} onChange={e => setPlantInput({...plantInput, type: e.target.value})} className={`w-full p-2 rounded-lg ${colors.input}`} />
                                                    <input type="number" placeholder="Minutos" value={plantInput.duration} onChange={e => setPlantInput({...plantInput, duration: e.target.value})} className={`w-full p-2 rounded-lg text-center ${colors.input}`} />
                                                    <Button colors={colors} variant="emerald" onClick={() => { if(plantInput.type && plantInput.duration) { updateActiveLog('plants', [...dayLog.plants, {type: plantInput.type, duration: parseInt(plantInput.duration)}]); setPlantInput({type:'',duration:''}); } }} className="w-full text-xs py-1.5">Salvar</Button>
                                                </div>
                                                {dayLog.plants?.map((p, i) => <div key={i} className={`flex justify-between items-center ${colors.translucent} p-2 rounded-lg text-xs mt-1`}><span className={`truncate mr-1 ${colors.textStrong}`}>{p.type}</span><button onClick={() => updateActiveLog('plants', dayLog.plants.filter((_, idx) => idx !== i))} className="text-red-400 shrink-0"><i className="ph-bold ph-x"></i></button></div>)}
                                            </Card>
                                        </div>

                                        {/* Exerc√≠cio e Hobby */}
                                        <div className="grid grid-cols-2 gap-4">
                                            <Card colors={colors} className={`${colors.accent} bg-opacity-20 p-4`}>
                                                <div className="flex items-center gap-2 mb-3"><i className={`ph-fill ph-activity ${colors.accentText}`}></i><h3 className={`font-semibold text-sm ${colors.text}`}>Exerc√≠cio</h3></div>
                                                <div className="space-y-2 mb-3">
                                                    <input placeholder="Treino" value={exerciseInput.type} onChange={e => setExerciseInput({...exerciseInput, type: e.target.value})} className={`w-full p-2 rounded-lg ${colors.input}`} />
                                                    <div className="flex gap-2">
                                                        <input type="number" placeholder="Min" value={exerciseInput.duration} onChange={e => setExerciseInput({...exerciseInput, duration: e.target.value})} className={`flex-1 min-w-0 p-2 rounded-lg text-center ${colors.input}`} />
                                                        <input type="number" placeholder="Kcal" value={exerciseInput.calories} onChange={e => setExerciseInput({...exerciseInput, calories: e.target.value})} className={`flex-1 min-w-0 p-2 rounded-lg text-center ${colors.input}`} />
                                                    </div>
                                                    <Button colors={colors} variant="accent" onClick={() => { if(exerciseInput.type && exerciseInput.duration) { updateActiveLog('exercises', [...dayLog.exercises, {type: exerciseInput.type, duration: parseInt(exerciseInput.duration), calories: parseInt(exerciseInput.calories||0)}]); setExerciseInput({type:'',duration:'',calories:''}); } }} className="w-full text-xs py-1.5">Salvar</Button>
                                                </div>
                                                {dayLog.exercises?.map((ex, i) => <div key={i} className={`flex justify-between items-center ${colors.translucent} p-2 rounded-lg text-xs mt-1`}><span className={`truncate mr-1 ${colors.textStrong}`}>{ex.type}</span><button onClick={() => updateActiveLog('exercises', dayLog.exercises.filter((_, idx) => idx !== i))} className="text-red-400 shrink-0"><i className="ph-bold ph-x"></i></button></div>)}
                                            </Card>

                                            <Card colors={colors} className={`${colors.primary} bg-opacity-20 p-4`}>
                                                <div className="flex items-center gap-2 mb-3"><i className={`ph-fill ph-coffee ${colors.primaryText}`}></i><h3 className={`font-semibold text-sm ${colors.text}`}>Hobby</h3></div>
                                                <div className="space-y-2 mb-3">
                                                    <input placeholder="Atividade" value={hobbyInput.type} onChange={e => setHobbyInput({...hobbyInput, type: e.target.value})} className={`w-full p-2 rounded-lg ${colors.input}`} />
                                                    <input type="number" placeholder="Minutos" value={hobbyInput.duration} onChange={e => setHobbyInput({...hobbyInput, duration: e.target.value})} className={`w-full p-2 rounded-lg text-center ${colors.input}`} />
                                                    <Button colors={colors} variant="primary" onClick={() => { if(hobbyInput.type && hobbyInput.duration) { updateActiveLog('hobbies', [...dayLog.hobbies, {type: hobbyInput.type, duration: parseInt(hobbyInput.duration)}]); setHobbyInput({type:'',duration:''}); } }} className="w-full text-xs py-1.5">Salvar</Button>
                                                </div>
                                                {dayLog.hobbies?.map((hb, i) => <div key={i} className={`flex justify-between items-center ${colors.translucent} p-2 rounded-lg text-xs mt-1`}><span className={`truncate mr-1 ${colors.textStrong}`}>{hb.type}</span><button onClick={() => updateActiveLog('hobbies', dayLog.hobbies.filter((_, idx) => idx !== i))} className="text-red-400 shrink-0"><i className="ph-bold ph-x"></i></button></div>)}
                                            </Card>
                                        </div>
                                    </div>
                                </div>
                            )}

                            {/* --- ESTAT√çSTICAS --- */}
                            {activeTab === 'stats' && (
                                <div className="space-y-6 animate-in">
                                    <div className="flex gap-2 overflow-x-auto pb-2 scrollbar-hide">
                                        {[1, 3, 7, 15, 30].map(days => (
                                            <button key={days} onClick={() => setStatsPeriod(days)} className={`px-4 py-2 rounded-full text-sm font-bold whitespace-nowrap ${statsPeriod === days ? `${colors.primary} ${colors.primaryText}` : `${colors.card} ${colors.textLight} border ${colors.border}`}`}>{days === 1 ? 'Hoje' : `${days} Dias`}</button>
                                        ))}
                                    </div>
                                    <div className="grid grid-cols-2 gap-4">
                                        {/* Humor Predominante */}
                                        <Card colors={colors} className="col-span-2 flex justify-between items-center">
                                            <div><p className={`text-sm ${colors.textLight}`}>Humor Geral</p><h3 className={`text-lg font-bold ${colors.textStrong}`}>{statsPeriod === 1 ? 'Hoje' : `√öltimos ${statsPeriod} dias`}</h3></div>
                                            <div className={`p-4 rounded-full ${colors.yellow} bg-opacity-30`}><i className={`ph-fill ${stats.topMood.icon} ${stats.topMood.color} text-4xl`}></i></div>
                                        </Card>

                                        {/* Trabalho Detalhado */}
                                        <Card colors={colors} className={`col-span-2 ${colors.purpleCard}`}>
                                            <div className="flex justify-between items-start mb-4">
                                                <h3 className={`font-semibold ${colors.text} flex items-center gap-2`}><i className={`ph-fill ph-briefcase ${colors.purpleText}`}></i> Trabalho</h3>
                                                {stats.topWorkMood && <div className="text-right"><p className={`text-xs ${colors.textMuted} mb-1`}>Humor Frequente</p><i className={`ph-fill ${stats.topWorkMood.icon} ${stats.topWorkMood.color} text-2xl`}></i></div>}
                                            </div>
                                            <div className={`${colors.translucentStrong} p-3 rounded-2xl flex justify-between items-center`}>
                                                <span className={`text-sm ${colors.textLight}`}>Horas efetivas (sem pausas)</span>
                                                <span className={`text-xl font-bold ${colors.purpleText}`}>{Math.floor(stats.totalWorkMins/60)}h {stats.totalWorkMins%60}m</span>
                                            </div>
                                        </Card>
                                        
                                        <Card colors={colors} className="flex flex-col items-center text-center gap-2 p-4">
                                            <i className={`ph-fill ph-pill ${colors.blueText} text-3xl`}></i>
                                            <p className={`text-xs ${colors.textLight}`}>Rem√©dios</p>
                                            <p className={`text-2xl font-bold ${colors.textStrong}`}>{stats.medAdherence}%</p>
                                        </Card>
                                        
                                        <Card colors={colors} className="flex flex-col items-center text-center gap-2 p-4">
                                            <i className="ph-fill ph-moon text-indigo-400 text-3xl"></i>
                                            <p className={`text-xs ${colors.textLight}`}>Sono (M√©dia)</p>
                                            <p className={`text-2xl font-bold ${colors.indigoText}`}>{stats.avgSleep}h</p>
                                        </Card>

                                        <Card colors={colors} className={`col-span-1 flex flex-col items-center text-center gap-2 p-4 ${colors.orange} bg-opacity-20`}>
                                            <i className={`ph-fill ph-broom ${colors.orangeText} text-3xl`}></i>
                                            <p className={`text-xs ${colors.textLight}`}>Tarefas Dom√©sticas</p>
                                            <p className={`text-xl font-bold ${colors.orangeText}`}>{Math.floor(stats.totalChoresMins/60)}h {stats.totalChoresMins%60}m</p>
                                        </Card>
                                        
                                        <Card colors={colors} className={`col-span-1 flex flex-col items-center text-center gap-2 p-4 ${colors.teal} bg-opacity-20`}>
                                            <i className={`ph-fill ph-paw-print ${colors.tealText} text-3xl`}></i>
                                            <p className={`text-xs ${colors.textLight}`}>Pets</p>
                                            <p className={`text-xl font-bold ${colors.tealText}`}>{Math.floor(stats.totalPetsMins/60)}h {stats.totalPetsMins%60}m</p>
                                        </Card>

                                        <Card colors={colors} className={`col-span-1 flex flex-col items-center text-center gap-2 p-4 ${colors.emerald} bg-opacity-20`}>
                                            <i className={`ph-fill ph-potted-plant ${colors.emeraldText} text-3xl`}></i>
                                            <p className={`text-xs ${colors.textLight}`}>Plantas</p>
                                            <p className={`text-xl font-bold ${colors.emeraldText}`}>{Math.floor(stats.totalPlantsMins/60)}h {stats.totalPlantsMins%60}m</p>
                                        </Card>

                                        <Card colors={colors} className={`col-span-1 flex flex-col items-center text-center gap-2 p-4 ${colors.primary} bg-opacity-20`}>
                                            <i className={`ph-fill ph-coffee ${colors.primaryText} text-3xl`}></i>
                                            <p className={`text-xs ${colors.textLight}`}>Hobbies</p>
                                            <p className={`text-xl font-bold ${colors.primaryText}`}>{Math.floor(stats.totalHobbyMins/60)}h {stats.totalHobbyMins%60}m</p>
                                        </Card>

                                        <Card colors={colors} className={`col-span-2 flex justify-between items-center p-5 ${colors.greenCard} bg-opacity-20`}>
                                            <div>
                                                <p className={`text-xs ${colors.textLight} mb-1`}>Consumo de Cannabis</p>
                                                <p className={`text-2xl font-bold ${colors.greenText}`}>{stats.totalCannabis} <span className="text-sm font-normal">vezes</span></p>
                                            </div>
                                            <i className="fa-solid fa-cannabis text-green-500 text-5xl opacity-40"></i>
                                        </Card>

                                        <Card colors={colors} className="col-span-2">
                                            <h3 className={`font-semibold ${colors.text} flex items-center gap-2 mb-4`}><i className="ph-fill ph-activity"></i> Esfor√ßo F√≠sico</h3>
                                            <div className="flex gap-4"><div className="flex-1"><p className={`text-xs ${colors.textLight}`}>Minutos</p><p className={`text-xl font-bold ${colors.accentText}`}>{stats.totalExMins}</p></div><div className="flex-1"><p className={`text-xs ${colors.textLight}`}>Calorias</p><p className="text-xl font-bold text-orange-500">{stats.totalExCals}</p></div></div>
                                        </Card>
                                    </div>
                                </div>
                            )}

                            {/* --- CALEND√ÅRIO & HIST√ìRICO --- */}
                            {activeTab === 'calendar' && (
                                <div className="space-y-6 animate-in">
                                    <Card colors={colors} className="p-4">
                                        <div className="flex justify-between items-center mb-6">
                                            <button onClick={() => setViewingMonth(new Date(currentYear, currentMonthIndex - 1, 1))} className={`p-2 ${colors.surface} rounded-full`}><i className="ph-bold ph-caret-left"></i></button>
                                            <h2 className={`font-bold ${colors.textStrong}`}>{MONTHS[currentMonthIndex]} {currentYear}</h2>
                                            <button onClick={() => setViewingMonth(new Date(currentYear, currentMonthIndex + 1, 1))} className={`p-2 ${colors.surface} rounded-full`}><i className="ph-bold ph-caret-right"></i></button>
                                        </div>
                                        <div className="grid grid-cols-7 gap-y-2 text-center">
                                            {WEEKDAYS.map(day => <div key={day} className={`text-xs font-bold ${colors.textLight} py-2`}>{day}</div>)}
                                            {blanks.map(blank => <div key={`blank-${blank}`} className="w-8 h-8"></div>)}
                                            {monthDays.map(day => {
                                                const dateStr = `${currentYear}-${String(currentMonthIndex + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                                                const dayData = logs[dateStr];
                                                const hasData = dayData && (dayData.moods?.length>0 || dayData.sleep?.hours>0 || dayData.work || dayData.cannabis>0 || dayData.pets?.length>0 || dayData.plants?.length>0 || dayData.chores?.length>0 || dayData.exercises?.length>0 || dayData.hobbies?.length>0);
                                                const isSel = selectedHistoryDate === dateStr;
                                                return (
                                                    <button key={day} onClick={() => setSelectedHistoryDate(dateStr)} className={`w-8 h-8 mx-auto flex flex-col items-center justify-center rounded-xl font-bold text-sm ${isSel ? `${colors.primary} ${colors.primaryText}` : `${colors.text} hover:${colors.surfaceHover}`}`}>
                                                        {day}
                                                        {hasData && <span className={`w-1 h-1 rounded-full mt-0.5 ${isSel ? 'bg-[#4A6B5D]' : 'bg-stone-300'}`}></span>}
                                                    </button>
                                                )
                                            })}
                                        </div>
                                    </Card>

                                    <div className="mt-8 mb-8">
                                        <h3 className={`text-lg font-bold ${colors.text} mb-4 flex justify-between items-center`}>
                                            <span><i className="ph-fill ph-calendar"></i> {formatDateVisual(selectedHistoryDate)}</span>
                                        </h3>
                                        
                                        {logs[selectedHistoryDate] && Object.keys(logs[selectedHistoryDate]).length > 0 ? (
                                            <div className="space-y-4">
                                                {/* Detalhes do Dia */}
                                                <div className="grid grid-cols-2 gap-3">
                                                    {logs[selectedHistoryDate].moods?.length > 0 && (
                                                        <Card colors={colors} className={`col-span-2 p-4 ${colors.surface}`}>
                                                            <div className="flex gap-2 flex-wrap">
                                                                {logs[selectedHistoryDate].moods.map((m, i) => <div key={i} className={`flex items-center gap-1 ${colors.card} px-3 py-1 rounded-full text-xs shadow-sm border ${colors.border}`}><i className={`ph-fill ${MOODS.find(x=>x.id===m.mood)?.icon} ${MOODS.find(x=>x.id===m.mood)?.color}`}></i> <span className={`font-medium ${colors.textStrong}`}>{m.time}</span></div>)}
                                                            </div>
                                                        </Card>
                                                    )}
                                                    
                                                    {logs[selectedHistoryDate].work && (
                                                        <Card colors={colors} className={`col-span-2 p-4 ${colors.purpleCard}`}>
                                                            <div className="flex justify-between items-center">
                                                                <div>
                                                                    <p className={`text-xs ${colors.purpleText} font-bold`}><i className="ph-fill ph-briefcase"></i> Trabalho</p>
                                                                    <p className={`font-bold ${colors.textStrong} text-sm mt-1`}>{logs[selectedHistoryDate].work.entry} - {logs[selectedHistoryDate].work.exit}</p>
                                                                    <p className={`text-xs ${colors.textMuted} font-medium mt-1`}>Pausa: {logs[selectedHistoryDate].work.pause}m</p>
                                                                </div>
                                                                <i className={`ph-fill ${MOODS.find(m => m.id === logs[selectedHistoryDate].work.mood)?.icon} ${MOODS.find(m => m.id === logs[selectedHistoryDate].work.mood)?.color} text-3xl`}></i>
                                                            </div>
                                                        </Card>
                                                    )}

                                                    {medications.length > 0 && (
                                                        <Card colors={colors} className={`col-span-2 p-4 ${colors.blueCard}`}>
                                                            <p className={`text-xs ${colors.blueTextAlt} font-bold`}><i className="ph-fill ph-pill"></i> Medica√ß√£o</p>
                                                            <div className="mt-2 space-y-1">
                                                                {medications.map(med => {
                                                                    const taken = logs[selectedHistoryDate].meds?.[med.id];
                                                                    return <p key={med.id} className={`text-xs ${taken ? colors.textStrong + ' font-medium' : colors.textMuted + ' line-through'}`}>{taken ? '‚úÖ' : '‚ùå'} {med.name}</p>
                                                                })}
                                                            </div>
                                                        </Card>
                                                    )}

                                                    {logs[selectedHistoryDate].sleep?.hours > 0 && (
                                                        <Card colors={colors} className={`p-4 ${colors.indigoCard}`}>
                                                            <p className={`text-xs ${colors.indigoText} font-bold`}><i className="ph-fill ph-moon"></i> Sono</p>
                                                            <p className={`font-bold ${colors.indigoText} text-lg mt-1`}>{logs[selectedHistoryDate].sleep.hours}h</p>
                                                        </Card>
                                                    )}

                                                    {(logs[selectedHistoryDate].cannabis > 0) && (
                                                        <Card colors={colors} className={`p-4 ${colors.greenCard} bg-opacity-20`}>
                                                            <p className={`text-xs ${colors.greenText} font-bold flex items-center gap-1`}><i className="fa-solid fa-cannabis text-sm"></i> Consumo</p>
                                                            <p className={`font-bold ${colors.greenText} text-lg mt-1`}>{logs[selectedHistoryDate].cannabis} <span className="text-xs font-normal">x</span></p>
                                                        </Card>
                                                    )}

                                                    {logs[selectedHistoryDate].chores?.length > 0 && (
                                                        <Card colors={colors} className={`col-span-2 p-4 ${colors.orange} bg-opacity-20`}>
                                                            <p className={`text-xs ${colors.orangeText} font-bold`}><i className="ph-fill ph-broom"></i> Casa</p>
                                                            <div className="mt-2 space-y-1">
                                                                {logs[selectedHistoryDate].chores.map((c,i) => <p key={i} className={`text-sm font-medium ${colors.textStrong}`}>{c.type} <span className={`text-xs font-normal ${colors.textMuted}`}>({c.duration}m)</span></p>)}
                                                            </div>
                                                        </Card>
                                                    )}

                                                    {logs[selectedHistoryDate].pets?.length > 0 && (
                                                        <Card colors={colors} className={`col-span-1 p-4 ${colors.teal} bg-opacity-20`}>
                                                            <p className={`text-xs ${colors.tealText} font-bold`}><i className="ph-fill ph-paw-print"></i> Pets</p>
                                                            <div className="mt-2 space-y-1">
                                                                {logs[selectedHistoryDate].pets.map((p,i) => <p key={i} className={`text-sm font-medium ${colors.textStrong}`}>{p.type} <span className={`text-xs font-normal ${colors.textMuted}`}>({p.duration}m)</span></p>)}
                                                            </div>
                                                        </Card>
                                                    )}

                                                    {logs[selectedHistoryDate].plants?.length > 0 && (
                                                        <Card colors={colors} className={`col-span-1 p-4 ${colors.emerald} bg-opacity-20`}>
                                                            <p className={`text-xs ${colors.emeraldText} font-bold`}><i className="ph-fill ph-potted-plant"></i> Plantas</p>
                                                            <div className="mt-2 space-y-1">
                                                                {logs[selectedHistoryDate].plants.map((p,i) => <p key={i} className={`text-sm font-medium ${colors.textStrong}`}>{p.type} <span className={`text-xs font-normal ${colors.textMuted}`}>({p.duration}m)</span></p>)}
                                                            </div>
                                                        </Card>
                                                    )}

                                                    {logs[selectedHistoryDate].exercises?.length > 0 && (
                                                        <Card colors={colors} className={`col-span-2 p-4 ${colors.accent} bg-opacity-20`}>
                                                            <p className={`text-xs ${colors.accentText} font-bold`}><i className="ph-fill ph-activity"></i> Exerc√≠cio</p>
                                                            <div className="mt-2 space-y-1">
                                                                {logs[selectedHistoryDate].exercises.map((e,i) => <p key={i} className={`text-sm font-medium ${colors.textStrong}`}>{e.type} <span className={`text-xs font-normal ${colors.textMuted}`}>({e.duration}m | {e.calories}kcal)</span></p>)}
                                                            </div>
                                                        </Card>
                                                    )}

                                                    {logs[selectedHistoryDate].hobbies?.length > 0 && (
                                                        <Card colors={colors} className={`col-span-2 p-4 ${colors.primary} bg-opacity-20`}>
                                                            <p className={`text-xs ${colors.primaryText} font-bold`}><i className="ph-fill ph-coffee"></i> Hobbies</p>
                                                            <div className="mt-2 space-y-1">
                                                                {logs[selectedHistoryDate].hobbies.map((h,i) => <p key={i} className={`text-sm font-medium ${colors.textStrong}`}>{h.type} <span className={`text-xs font-normal ${colors.textMuted}`}>({h.duration}m)</span></p>)}
                                                            </div>
                                                        </Card>
                                                    )}

                                                </div>

                                                <Button colors={colors} variant="outline" onClick={() => { setActiveDateStr(selectedHistoryDate); setActiveTab('home'); }} className="w-full mt-4 text-sm border-2">
                                                    <i className="ph-bold ph-pencil-simple"></i> Editar este dia
                                                </Button>
                                            </div>
                                        ) : (
                                            <div className="text-center py-8">
                                                <p className={`text-sm ${colors.textMuted} mb-4`}>Nenhum registo neste dia.</p>
                                                <Button colors={colors} variant="primary" onClick={() => { setActiveDateStr(selectedHistoryDate); setActiveTab('home'); }} className="mx-auto text-sm">
                                                    <i className="ph-bold ph-plus"></i> Criar registo
                                                </Button>
                                            </div>
                                        )}
                                    </div>
                                </div>
                            )}
                        </div>

                        {/* --- NAVEGA√á√ÉO INFERIOR --- */}
                        <div className={`absolute bottom-0 w-full ${colors.bottomNav} backdrop-blur-lg border-t px-6 py-4 pb-8 flex justify-around`}>
                            <button onClick={() => setActiveTab('home')} className={`p-3 rounded-2xl flex flex-col items-center gap-1 ${activeTab === 'home' ? `${colors.primary} ${colors.primaryText}` : colors.textLight}`}><i className="ph-fill ph-book-open text-2xl"></i><span className="text-[9px] font-bold uppercase">Di√°rio</span></button>
                            <button onClick={() => setActiveTab('calendar')} className={`p-3 rounded-2xl flex flex-col items-center gap-1 ${activeTab === 'calendar' ? `${colors.primary} ${colors.primaryText}` : colors.textLight}`}><i className="ph-fill ph-calendar-blank text-2xl"></i><span className="text-[9px] font-bold uppercase">Hist√≥rico</span></button>
                            <button onClick={() => setActiveTab('stats')} className={`p-3 rounded-2xl flex flex-col items-center gap-1 ${activeTab === 'stats' ? `${colors.primary} ${colors.primaryText}` : colors.textLight}`}><i className="ph-fill ph-chart-bar text-2xl"></i><span className="text-[9px] font-bold uppercase">Estat√≠sticas</span></button>
                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>


