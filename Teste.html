<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Comfy Life</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Phosphor Icons (√çcones Seguros para HTML) -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel (Para compilar o c√≥digo React no navegador) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400..900;1,400..900&family=Plus+Jakarta+Sans:wght@200..800&display=swap');
        
        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            -webkit-tap-highlight-color: transparent;
        }
        .font-serif { font-family: 'Playfair Display', serif; }
        
        /* Esconder a barra de scroll mas manter o scroll */
        ::-webkit-scrollbar { display: none; }
        * { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Anima√ß√µes suaves */
        .animate-in { animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes fadeIn { 
            from { opacity: 0; transform: translateY(15px); } 
            to { opacity: 1; transform: translateY(0); } 
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // --- SISTEMA DE CORES (CLARO / ESCURO) ---
        const getThemeColors = (isDark) => ({
            bg: isDark ? 'bg-[#1C1A19]' : 'bg-[#F9F6F0]',
            card: isDark ? 'bg-[#282624]' : 'bg-white',
            surface: isDark ? 'bg-[#32302D]' : 'bg-stone-50',
            surfaceHover: isDark ? 'hover:bg-[#3D3A36]' : 'hover:bg-stone-100',
            surfaceAlt: isDark ? 'bg-[#3D3A36]' : 'bg-stone-100',
            text: isDark ? 'text-[#D6D0C4]' : 'text-[#5C544E]',
            textStrong: isDark ? 'text-[#F0EBE1]' : 'text-stone-700',
            textMuted: isDark ? 'text-[#A39D93]' : 'text-stone-500',
            textLight: isDark ? 'text-[#8A847A]' : 'text-[#9A8F85]',
            iconMuted: isDark ? 'text-[#5A5550]' : 'text-stone-300',
            primary: isDark ? 'bg-[#384A41]' : 'bg-[#D2E0D9]',
            primaryText: isDark ? 'text-[#A5C2B3]' : 'text-[#4A6B5D]',
            accent: isDark ? 'bg-[#5C3C3A]' : 'bg-[#F3D8D6]',
            accentText: isDark ? 'text-[#DEAAA7]' : 'text-[#9C5A56]',
            yellow: isDark ? 'bg-[#4A3D1A]' : 'bg-[#FDF3D8]',
            yellowText: isDark ? 'text-[#E0BE63]' : 'text-[#B08922]',
            blue: isDark ? 'bg-[#2C3E4F]' : 'bg-[#D6E4F0]',
            blueText: isDark ? 'text-[#9CB8D4]' : 'text-[#4A6984]',
            purple: isDark ? 'bg-[#3D2C4A]' : 'bg-[#E5D9F2]',
            purpleText: isDark ? 'text-[#BCA3D4]' : 'text-[#7A5C8A]',
            border: isDark ? 'border-[#3D3A36]' : 'border-[#EAE3D9]',
            bottomNav: isDark ? 'bg-[#282624]/90 border-[#3D3A36]' : 'bg-white/80 border-[#EAE3D9]',
            input: isDark ? 'bg-[#1C1A19] text-[#D6D0C4]' : 'bg-white text-stone-700',
            translucent: isDark ? 'bg-black/20' : 'bg-white/60',
            translucentStrong: isDark ? 'bg-black/40' : 'bg-white/70',
            notification: isDark ? 'bg-[#282624]/95 border-[#3D3A36]' : 'bg-white/95 border-stone-200',
            indigoCard: isDark ? 'bg-indigo-900/20 border-indigo-900/50' : 'bg-indigo-50/30 border-indigo-100',
            indigoText: isDark ? 'text-indigo-300' : 'text-indigo-900',
            blueCard: isDark ? 'bg-blue-900/20 border-blue-900/50' : 'bg-blue-50/30 border-blue-100',
            blueTextAlt: isDark ? 'text-blue-300' : 'text-blue-900',
            purpleCard: isDark ? 'bg-purple-900/20 border-purple-900/50' : 'bg-[#E5D9F2] bg-opacity-30 border-purple-100',
        });

        // --- DADOS E UTILIT√ÅRIOS ---
        const MOODS = [
            { id: 'awful', icon: 'ph-smiley-sad', color: 'text-red-400', label: 'P√©ssimo' },
            { id: 'bad', icon: 'ph-smiley-meh', color: 'text-orange-400', label: 'Triste' },
            { id: 'ok', icon: 'ph-smiley', color: 'text-yellow-500', label: 'Ok' },
            { id: 'good', icon: 'ph-heart', color: 'text-green-400', label: 'Bem' },
            { id: 'great', icon: 'ph-star', color: 'text-pink-400', label: '√ìtimo' },
        ];

        const SLEEP_QUALITIES = [
            { id: 'bad', label: 'ü•± Mau', val: 1 },
            { id: 'ok', label: 'üòå Ok', val: 2 },
            { id: 'good', label: 'üò¥ Bom', val: 3 },
            { id: 'great', label: 'ü§© Perfeito', val: 4 },
        ];

        const WEEKDAYS = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'S√°b'];
        const MONTHS = ['Janeiro', 'Fevereiro', 'Mar√ßo', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];

        const getTodayStr = () => {
            const d = new Date();
            return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
        };

        const formatTime = (date) => {
            return `${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;
        };

        // Gerador de dados falsos APENAS para a conta de teste
        const generateMockData = () => {
            const data = {};
            const today = new Date();
            for (let i = 30; i >= 0; i--) {
                const d = new Date(today);
                d.setDate(d.getDate() - i);
                const dateStr = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
                if (Math.random() < 0.1 && i !== 0) continue;

                data[dateStr] = {
                    moods: [
                        { time: '09:00', mood: MOODS[Math.floor(Math.random() * 5)].id },
                        { time: '15:00', mood: MOODS[Math.floor(Math.random() * 5)].id }
                    ],
                    sleep: { hours: Math.floor(Math.random() * 4) + 5, quality: SLEEP_QUALITIES[Math.floor(Math.random() * 4)].id },
                    meds: { '1': Math.random() > 0.2, '2': Math.random() > 0.4 }, 
                    exercises: Math.random() > 0.5 ? [{ type: 'Caminhada', duration: 30, calories: 150 }] : [],
                    hobbies: Math.random() > 0.3 ? [{ type: 'Leitura', duration: 45 }] : [],
                    work: Math.random() > 0.4 ? { entry: '08:00', exit: '17:00', mood: MOODS[Math.floor(Math.random() * 5)].id } : null,
                };
            }
            return data;
        };

        const INITIAL_USERS_DB = {
            'teste@teste.com': {
                password: '123',
                name: 'Visitante Teste',
                logs: generateMockData(),
                medications: [
                    { id: '1', name: 'Vitamina C', time: '09:00' },
                    { id: '2', name: 'Anti-al√©rgico', time: '20:00' }
                ]
            }
        };

        // --- COMPONENTES UI ---
        const Button = ({ children, onClick, variant = 'primary', className = '', active = false, colors }) => {
            const variants = {
                primary: `${colors.primary} ${colors.primaryText} hover:brightness-110`,
                accent: `${colors.accent} ${colors.accentText} hover:brightness-110`,
                purple: `${colors.purple} ${colors.purpleText} hover:brightness-110`,
                blue: `${colors.blue} ${colors.blueText} hover:brightness-110`,
            };
            return (
                <button onClick={onClick} className={`px-4 py-2 rounded-2xl font-bold transition-all flex items-center justify-center gap-2 ${variants[variant]} ${className}`}>
                    {children}
                </button>
            );
        };

        const Card = ({ children, className = '', colors }) => (
            <div className={`${colors.card} rounded-3xl p-6 shadow-sm border ${colors.border} transition-colors duration-300 ${className}`}>
                {children}
            </div>
        );

        // --- APP PRINCIPAL ---
        function App() {
            // PWA Manifest & Service Worker Din√¢mico
            const [deferredPrompt, setDeferredPrompt] = useState(null);
            
            useEffect(() => {
                // Injetar Manifest Din√¢mico para PWA
                const manifest = {
                    name: "Comfy Life",
                    short_name: "Comfy",
                    description: "O seu di√°rio aconchegante.",
                    start_url: "/",
                    display: "standalone",
                    background_color: "#F9F6F0",
                    theme_color: "#D2E0D9",
                    icons: [{ src: "https://cdn-icons-png.flaticon.com/512/833/833472.png", sizes: "512x512", type: "image/png" }]
                };
                const blob = new Blob([JSON.stringify(manifest)], {type: 'application/json'});
                const manifestURL = URL.createObjectURL(blob);
                let linkManifest = document.querySelector('link[rel="manifest"]');
                if (!linkManifest) {
                    linkManifest = document.createElement('link');
                    linkManifest.rel = 'manifest';
                    document.head.appendChild(linkManifest);
                }
                linkManifest.href = manifestURL;

                // Service Worker B√°sico (Offline Cache)
                if ('serviceWorker' in navigator) {
                    const swCode = `
                        self.addEventListener('install', (e) => self.skipWaiting());
                        self.addEventListener('fetch', (e) => {
                            e.respondWith(caches.match(e.request).then((res) => res || fetch(e.request)));
                        });
                    `;
                    const swBlob = new Blob([swCode], { type: 'text/javascript' });
                    const swUrl = URL.createObjectURL(swBlob);
                    navigator.serviceWorker.register(swUrl).catch(() => {});
                }

                const handleBIP = (e) => {
                    e.preventDefault();
                    setDeferredPrompt(e);
                };
                window.addEventListener('beforeinstallprompt', handleBIP);
                return () => window.removeEventListener('beforeinstallprompt', handleBIP);
            }, []);

            const handleInstallApp = () => {
                if (deferredPrompt) {
                    deferredPrompt.prompt();
                    deferredPrompt.userChoice.then(() => setDeferredPrompt(null));
                }
            };

            // Estados
            const [isDarkMode, setIsDarkMode] = useState(false);
            const colors = useMemo(() => getThemeColors(isDarkMode), [isDarkMode]);
            const toggleTheme = () => setIsDarkMode(!isDarkMode);

            const [usersDb, setUsersDb] = useState(INITIAL_USERS_DB);
            const [currentUserEmail, setCurrentUserEmail] = useState(null);

            const [authStep, setAuthStep] = useState('auth');
            const [isLoginFlow, setIsLoginFlow] = useState(true);
            const [userName, setUserName] = useState('');
            const [emailInput, setEmailInput] = useState('');
            const [passwordInput, setPasswordInput] = useState('');

            const [activeTab, setActiveTab] = useState('home');
            const [currentDateStr, setCurrentDateStr] = useState(getTodayStr());
            
            const [logs, setLogs] = useState({});
            const [medications, setMedications] = useState([]);
            const [notifications, setNotifications] = useState([]);

            const [exerciseInput, setExerciseInput] = useState({ type: '', duration: '', calories: '' });
            const [hobbyInput, setHobbyInput] = useState({ type: '', duration: '' });
            const [workInput, setWorkInput] = useState({ entry: '', exit: '', mood: 'ok' });
            const [isAddingMed, setIsAddingMed] = useState(false);
            const [newMedInput, setNewMedInput] = useState({ name: '', time: '08:00' });
            
            const [statsPeriod, setStatsPeriod] = useState(7);
            const [viewingMonth, setViewingMonth] = useState(new Date());
            const [selectedHistoryDate, setSelectedHistoryDate] = useState(getTodayStr());

            // Sincronizar DB
            useEffect(() => {
                if (currentUserEmail && authStep === 'app') {
                    setUsersDb(prev => ({ ...prev, [currentUserEmail]: { ...prev[currentUserEmail], logs, medications } }));
                }
            }, [logs, medications, currentUserEmail, authStep]);

            const todayLog = logs[currentDateStr] || { moods: [], sleep: { hours: 0, quality: '' }, meds: {}, exercises: [], hobbies: [], work: null };

            const updateTodayLog = (key, value) => {
                setLogs(prev => ({
                    ...prev, [currentDateStr]: { ...(prev[currentDateStr] || { moods: [], sleep: { hours: 0, quality: '' }, meds: {}, exercises: [], hobbies: [], work: null }), [key]: value }
                }));
            };

            // Alarmes
            useEffect(() => {
                const checkMeds = setInterval(() => {
                    if (authStep !== 'app') return;
                    const now = new Date();
                    const timeStr = formatTime(now);
                    medications.forEach(med => {
                        if (med.time === timeStr && !logs[currentDateStr]?.meds?.[med.id]) {
                            addNotification(`Hora de tomar: ${med.name}! üíä`);
                        }
                    });
                }, 60000);
                return () => clearInterval(checkMeds);
            }, [medications, logs, currentDateStr, authStep]);

            // Virada do dia
            useEffect(() => {
                const checkMidnight = setInterval(() => {
                    const newDateStr = getTodayStr();
                    if (newDateStr !== currentDateStr) setCurrentDateStr(newDateStr);
                }, 60000);
                return () => clearInterval(checkMidnight);
            }, [currentDateStr]);

            const addNotification = (msg) => {
                const id = Date.now();
                setNotifications(prev => [...prev, { id, msg }]);
                setTimeout(() => setNotifications(prev => prev.filter(n => n.id !== id)), 5000);
            };

            // Auth Handlers
            const handleAuthSubmit = () => {
                if (!emailInput || !passwordInput) return addNotification("Preencha o e-mail e a palavra-passe!");
                if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(emailInput)) return addNotification("E-mail inv√°lido!");

                const emailKey = emailInput.toLowerCase();
                if (isLoginFlow) {
                    const user = usersDb[emailKey];
                    if (user && user.password === passwordInput) {
                        setCurrentUserEmail(emailKey); setUserName(user.name);
                        setLogs(user.logs || {}); setMedications(user.medications || []);
                        setAuthStep('app'); setActiveTab('home');
                    } else addNotification("E-mail ou palavra-passe incorretos!");
                } else {
                    if (usersDb[emailKey]) return addNotification("Este e-mail j√° est√° registado!");
                    setLogs({}); setMedications([]); setAuthStep('onboarding');
                }
            };

            const handleOnboardingSubmit = () => {
                if (!userName.trim()) return addNotification("Por favor, digite o seu nome!");
                const emailKey = emailInput.toLowerCase();
                setUsersDb(prev => ({ ...prev, [emailKey]: { password: passwordInput, name: userName.trim(), logs: {}, medications: [] } }));
                setCurrentUserEmail(emailKey); setAuthStep('app'); setActiveTab('home');
            };

            const handleLogout = () => {
                setAuthStep('auth'); setCurrentUserEmail(null); setUserName('');
                setEmailInput(''); setPasswordInput(''); setLogs({}); setMedications([]);
            };

            // App Handlers
            const handleSaveSleep = (hours, quality) => updateTodayLog('sleep', { hours, quality });
            
            const handleAddMedication = () => {
                if (newMedInput.name && newMedInput.time) {
                    setMedications([...medications, { id: Date.now().toString(), name: newMedInput.name, time: newMedInput.time }]);
                    setNewMedInput({ name: '', time: '08:00' }); setIsAddingMed(false);
                } else addNotification("Preencha o nome e a hora do rem√©dio!");
            };

            // Estat√≠sticas
            const stats = useMemo(() => {
                const today = new Date();
                let totalSleep = 0; let sleepDays = 0;
                let medTaken = 0; let medTotal = 0;
                let totalExMins = 0; let totalExCals = 0;
                let totalHobbyMins = 0; let totalWorkMins = 0;
                const moodCounts = {};

                for (let i = 0; i < statsPeriod; i++) {
                    const d = new Date(today); d.setDate(d.getDate() - i);
                    const dateStr = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
                    const dayLog = logs[dateStr];

                    if (dayLog) {
                        if (dayLog.sleep?.hours) { totalSleep += dayLog.sleep.hours; sleepDays++; }
                        medications.forEach(med => { medTotal++; if (dayLog.meds?.[med.id]) medTaken++; });
                        dayLog.exercises?.forEach(ex => { totalExMins += ex.duration; totalExCals += (ex.calories || 0); });
                        dayLog.hobbies?.forEach(hb => { totalHobbyMins += hb.duration; });
                        if (dayLog.work?.entry && dayLog.work?.exit) {
                            const [eH, eM] = dayLog.work.entry.split(':').map(Number);
                            const [xH, xM] = dayLog.work.exit.split(':').map(Number);
                            let mins = (xH * 60 + xM) - (eH * 60 + eM);
                            if (mins < 0) mins += 24 * 60;
                            totalWorkMins += mins;
                        }
                        dayLog.moods?.forEach(m => { moodCounts[m.mood] = (moodCounts[m.mood] || 0) + 1; });
                    }
                }

                const avgSleep = sleepDays ? (totalSleep / sleepDays).toFixed(1) : 0;
                const medAdherence = medTotal ? Math.round((medTaken / medTotal) * 100) : 0;
                const topMoodId = Object.keys(moodCounts).sort((a,b) => moodCounts[b] - moodCounts[a])[0];
                const topMood = MOODS.find(m => m.id === topMoodId) || MOODS[2];

                return { avgSleep, medAdherence, totalExMins, totalExCals, totalHobbyMins, totalWorkMins, topMood };
            }, [statsPeriod, logs, medications]);

            // Calend√°rio
            const currentYear = viewingMonth.getFullYear();
            const currentMonthIndex = viewingMonth.getMonth();
            const daysInMonth = new Date(currentYear, currentMonthIndex + 1, 0).getDate();
            const firstDayOfWeek = new Date(currentYear, currentMonthIndex, 1).getDay();
            const blanks = Array.from({ length: firstDayOfWeek }, (_, i) => i);
            const monthDays = Array.from({ length: daysInMonth }, (_, i) => i + 1);

            // --- RENDERIZA√á√ÉO ---
            if (authStep === 'auth') {
                return (
                    <div className={`min-h-screen ${colors.bg} flex items-center justify-center p-4 transition-colors duration-500`}>
                        <div className={`max-w-md w-full relative ${colors.bg} shadow-2xl flex flex-col rounded-[2.5rem] border ${colors.border} transition-colors duration-500`}>
                            <div className="p-8 flex flex-col items-center text-center space-y-6">
                                <div className="flex w-full justify-between items-center absolute top-6 px-6">
                                    <button onClick={toggleTheme} className={`${colors.yellow} p-3 rounded-full shadow-sm`}>
                                        <i className={`ph-fill ${isDarkMode ? 'ph-moon' : 'ph-sun'} ${colors.yellowText} text-xl`}></i>
                                    </button>
                                    {deferredPrompt && (
                                        <button onClick={handleInstallApp} className={`${colors.primary} ${colors.primaryText} p-3 rounded-full shadow-sm flex items-center gap-2 text-xs font-bold`}>
                                            <i className="ph-bold ph-download-simple text-lg"></i> Instalar
                                        </button>
                                    )}
                                </div>
                                <div className="mt-12">
                                    <i className={`ph-fill ph-heart ${colors.accentText} text-5xl mx-auto mb-4 block`}></i>
                                    <h1 className={`text-3xl font-bold ${colors.text} font-serif`}>Comfy Life</h1>
                                    <p className={`text-sm ${colors.textLight} mt-2`}>O seu espa√ßo seguro e aconchegante para registar os seus dias.</p>
                                </div>
                                <div className="w-full space-y-4 mt-8">
                                    <div className={`flex items-center ${colors.card} px-4 py-3 rounded-2xl border ${colors.border}`}>
                                        <i className={`ph-fill ph-envelope ${colors.textLight} text-xl`}></i>
                                        <input type="email" placeholder="O seu e-mail" value={emailInput} onChange={e => setEmailInput(e.target.value)} className={`w-full ml-3 border-none outline-none text-sm bg-transparent ${colors.textStrong}`} />
                                    </div>
                                    <div className={`flex items-center ${colors.card} px-4 py-3 rounded-2xl border ${colors.border}`}>
                                        <i className={`ph-fill ph-lock-key ${colors.textLight} text-xl`}></i>
                                        <input type="password" placeholder="A sua palavra-passe" value={passwordInput} onChange={e => setPasswordInput(e.target.value)} className={`w-full ml-3 border-none outline-none text-sm bg-transparent ${colors.textStrong}`} />
                                    </div>
                                </div>
                                <Button colors={colors} variant="primary" onClick={handleAuthSubmit} className="w-full py-3 mt-4 text-lg">
                                    {isLoginFlow ? 'Entrar' : 'Criar Conta'}
                                </Button>
                                <button onClick={() => setIsLoginFlow(!isLoginFlow)} className={`text-sm font-medium ${colors.textLight} mt-4`}>
                                    {isLoginFlow ? 'N√£o tem uma conta? Cadastre-se' : 'J√° tem uma conta? Iniciar Sess√£o'}
                                </button>
                                {isLoginFlow && <p className={`text-xs ${colors.textMuted} mt-6 opacity-70`}>Dica: teste@teste.com / 123</p>}
                            </div>
                        </div>
                        {/* Notifica√ß√µes */}
                        <div className="absolute top-4 left-0 right-0 px-4 z-50 flex flex-col gap-2 pointer-events-none max-w-md mx-auto">
                            {notifications.map(n => (
                                <div key={n.id} className={`${colors.notification} backdrop-blur-md shadow-lg p-4 rounded-2xl flex items-center justify-between animate-in pointer-events-auto border`}>
                                    <div className="flex items-center gap-3">
                                        <div className="bg-blue-100 text-blue-600 p-2 rounded-full"><i className="ph-fill ph-bell"></i></div>
                                        <p className={`font-medium ${colors.textStrong} text-sm`}>{n.msg}</p>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                );
            }

            if (authStep === 'onboarding') {
                return (
                    <div className={`min-h-screen ${colors.bg} flex items-center justify-center p-4 transition-colors duration-500`}>
                        <div className={`max-w-md w-full relative ${colors.bg} shadow-2xl flex flex-col rounded-[2.5rem] border ${colors.border} p-8 text-center transition-colors duration-500`}>
                            <div className="flex flex-col items-center space-y-6">
                                <div className={`${colors.primary} p-4 rounded-full shadow-sm mb-2 mt-4`}>
                                    <i className={`ph-fill ph-smiley ${colors.primaryText} text-4xl`}></i>
                                </div>
                                <div>
                                    <h1 className={`text-2xl font-bold ${colors.text} font-serif`}>Como podemos trat√°-lo(a)?</h1>
                                    <p className={`text-sm ${colors.textLight} mt-2`}>A sua conta foi reservada.</p>
                                </div>
                                <div className="w-full mt-8">
                                    <div className={`flex items-center ${colors.card} px-4 py-3 rounded-2xl border ${colors.border}`}>
                                        <i className={`ph-fill ph-user ${colors.textLight} text-xl`}></i>
                                        <input type="text" placeholder="O seu nome ou alcunha" value={userName} onChange={e => setUserName(e.target.value)} className={`w-full ml-3 border-none outline-none text-sm bg-transparent ${colors.textStrong}`} />
                                    </div>
                                </div>
                                <Button colors={colors} variant="primary" onClick={handleOnboardingSubmit} className="w-full py-3 mt-6 text-lg">Come√ßar a minha jornada</Button>
                            </div>
                        </div>
                    </div>
                );
            }

            // APP PRINCIPAL
            return (
                <div className={`min-h-screen ${colors.bg} transition-colors duration-500`}>
                    <div className={`max-w-md mx-auto min-h-screen relative ${colors.bg} flex flex-col`}>
                        <div className="flex-1 overflow-y-auto p-6 scrollbar-hide pb-28">
                            
                            {/* --- HOME --- */}
                            {activeTab === 'home' && (
                                <div className="space-y-6 animate-in">
                                    <div className="flex justify-between items-end px-2">
                                        <div>
                                            <h2 className={`text-sm font-medium ${colors.textLight} uppercase tracking-wider mb-1`}>{new Date().toLocaleDateString('pt-BR', { weekday: 'long', month: 'long', day: 'numeric' })}</h2>
                                            <h1 className={`text-3xl font-bold ${colors.text} font-serif`}>Ol√°, {userName}!</h1>
                                        </div>
                                        <div className="flex items-center gap-2">
                                            {deferredPrompt && (
                                                <button onClick={handleInstallApp} className={`${colors.primary} ${colors.primaryText} p-3 rounded-full shadow-sm`}><i className="ph-bold ph-download-simple text-xl"></i></button>
                                            )}
                                            <button onClick={toggleTheme} className={`${colors.yellow} p-3 rounded-full shadow-sm`}><i className={`ph-fill ${isDarkMode ? 'ph-moon' : 'ph-sun'} ${colors.yellowText} text-xl`}></i></button>
                                            <button onClick={handleLogout} className={`${colors.card} border ${colors.border} p-3 rounded-full text-red-400 shadow-sm`}><i className="ph-bold ph-sign-out text-xl"></i></button>
                                        </div>
                                    </div>

                                    {/* Humor */}
                                    <Card colors={colors}>
                                        <div className="flex items-center gap-2 mb-4">
                                            <i className={`ph-fill ph-heart ${colors.accentText} text-xl`}></i>
                                            <h3 className={`font-semibold ${colors.text}`}>O meu Humor</h3>
                                        </div>
                                        <div className={`flex justify-between items-center ${colors.surface} p-4 rounded-2xl mb-4`}>
                                            {MOODS.map(m => (
                                                <button key={m.id} onClick={() => updateTodayLog('moods', [...todayLog.moods, {time: formatTime(new Date()), mood: m.id}])} className={`hover:scale-110 transition-transform ${m.color}`}>
                                                    <i className={`ph-fill ${m.icon} text-4xl`}></i>
                                                </button>
                                            ))}
                                        </div>
                                        {todayLog.moods.length > 0 && (
                                            <div className="space-y-2">
                                                <div className="flex flex-wrap gap-2">
                                                    {todayLog.moods.map((m, i) => {
                                                        const moodData = MOODS.find(x => x.id === m.mood);
                                                        return (
                                                            <div key={i} className={`flex items-center gap-1 ${colors.surfaceAlt} px-3 py-1.5 rounded-full text-sm`}>
                                                                <i className={`ph-fill ${moodData.icon} ${moodData.color}`}></i>
                                                                <span className={`font-medium ${colors.textLight}`}>{m.time}</span>
                                                            </div>
                                                        );
                                                    })}
                                                </div>
                                            </div>
                                        )}
                                    </Card>

                                    {/* Medica√ß√£o */}
                                    <Card colors={colors}>
                                        <div className="flex items-center justify-between mb-4">
                                            <div className="flex items-center gap-2">
                                                <i className={`ph-fill ph-pill ${colors.blueText} text-xl`}></i>
                                                <h3 className={`font-semibold ${colors.text}`}>Medica√ß√£o</h3>
                                            </div>
                                            <button onClick={() => setIsAddingMed(!isAddingMed)} className={`p-1.5 rounded-full ${colors.blue} ${colors.blueText}`}>
                                                <i className={`ph-bold ${isAddingMed ? 'ph-x' : 'ph-plus'} text-lg`}></i>
                                            </button>
                                        </div>

                                        {isAddingMed && (
                                            <div className={`${colors.blueCard} p-4 rounded-2xl mb-4 space-y-3 border`}>
                                                <input placeholder="Nome do rem√©dio" value={newMedInput.name} onChange={e => setNewMedInput({...newMedInput, name: e.target.value})} className={`w-full px-4 py-2 rounded-xl border-none outline-none text-sm ${colors.input}`} />
                                                <div className="flex items-center gap-3">
                                                    <input type="time" value={newMedInput.time} onChange={e => setNewMedInput({...newMedInput, time: e.target.value})} className={`flex-1 px-4 py-2 rounded-xl border-none outline-none text-sm ${colors.input}`} />
                                                </div>
                                                <Button colors={colors} variant="blue" onClick={handleAddMedication} className="w-full py-2">Salvar</Button>
                                            </div>
                                        )}

                                        <div className="space-y-3">
                                            {medications.length === 0 ? (
                                                <p className={`text-sm ${colors.textLight} text-center py-2`}>Nenhum rem√©dio registado.</p>
                                            ) : (
                                                medications.map(med => {
                                                    const isTaken = todayLog.meds?.[med.id];
                                                    return (
                                                        <div key={med.id} className={`flex items-center justify-between p-4 rounded-2xl border ${isTaken ? `${colors.primary} border-transparent` : `${colors.surface} ${colors.border}`}`}>
                                                            <div className="flex items-center gap-3">
                                                                <div className={`p-2 rounded-full ${isTaken ? `${colors.translucent} ${colors.primaryText}` : `${colors.card} ${colors.iconMuted}`}`}>
                                                                    <i className="ph-fill ph-clock text-lg"></i>
                                                                </div>
                                                                <div>
                                                                    <p className={`font-bold ${isTaken ? colors.primaryText : colors.textStrong}`}>{med.name}</p>
                                                                    <p className={`text-sm ${isTaken ? colors.primaryText : colors.textLight} opacity-80`}>{med.time}</p>
                                                                </div>
                                                            </div>
                                                            <div className="flex gap-2">
                                                                <button onClick={() => setMedications(medications.filter(m => m.id !== med.id))} className="text-red-400 p-2"><i className="ph-bold ph-x text-lg"></i></button>
                                                                <button onClick={() => { const m = {...(todayLog.meds || {})}; m[med.id] = !m[med.id]; updateTodayLog('meds', m); }} className={`w-10 h-10 rounded-full flex items-center justify-center border-2 ${isTaken ? `${colors.card} ${colors.primaryText} shadow-sm border-transparent` : `${colors.border} text-transparent`}`}>
                                                                    <i className="ph-bold ph-check text-xl"></i>
                                                                </button>
                                                            </div>
                                                        </div>
                                                    )
                                                })
                                            )}
                                        </div>
                                    </Card>

                                    {/* Sono */}
                                    <Card colors={colors}>
                                        <div className="flex items-center gap-2 mb-4">
                                            <i className="ph-fill ph-moon text-indigo-400 text-xl"></i>
                                            <h3 className={`font-semibold ${colors.text}`}>Sono</h3>
                                        </div>
                                        <div className="space-y-4">
                                            <div>
                                                <label className={`text-sm ${colors.textLight} mb-2 block`}>Horas: <span className={`font-bold ${colors.indigoText}`}>{Number(todayLog.sleep?.hours || 0).toFixed(1).replace('.0', '')}h</span></label>
                                                <input type="range" min="0" max="14" step="0.1" value={todayLog.sleep?.hours || 0} onChange={(e) => updateTodayLog('sleep', { hours: parseFloat(e.target.value), quality: todayLog.sleep?.quality })} className="w-full accent-indigo-400" />
                                            </div>
                                            <div className="flex gap-2">
                                                {SLEEP_QUALITIES.map(q => (
                                                    <button key={q.id} onClick={() => updateTodayLog('sleep', { hours: todayLog.sleep?.hours || 0, quality: q.id })} className={`flex-1 py-2 rounded-xl text-xs font-bold ${todayLog.sleep?.quality === q.id ? 'bg-indigo-500/20 text-indigo-400' : `${colors.surface} ${colors.text}`}`}>
                                                        {q.label}
                                                    </button>
                                                ))}
                                            </div>
                                        </div>
                                    </Card>

                                    {/* Trabalho */}
                                    <Card colors={colors} className={`${colors.purple} bg-opacity-20`}>
                                        <div className="flex items-center gap-2 mb-4">
                                            <i className={`ph-fill ph-briefcase ${colors.purpleText} text-xl`}></i>
                                            <h3 className={`font-semibold ${colors.text}`}>Trabalho</h3>
                                        </div>
                                        {todayLog.work ? (
                                            <div className={`${colors.translucentStrong} p-4 rounded-xl flex justify-between items-center shadow-sm`}>
                                                <div>
                                                    <p className={`text-xs ${colors.textMuted} mb-1`}>Turno registado</p>
                                                    <p className={`font-bold ${colors.textStrong}`}>{todayLog.work.entry} √†s {todayLog.work.exit}</p>
                                                </div>
                                                <div className="flex gap-4 items-center">
                                                    <i className={`ph-fill ${MOODS.find(m => m.id === todayLog.work.mood)?.icon} ${MOODS.find(m => m.id === todayLog.work.mood)?.color} text-3xl ${colors.card} p-1 rounded-full`}></i>
                                                    <button onClick={() => updateTodayLog('work', null)} className="text-red-400"><i className="ph-bold ph-x text-xl"></i></button>
                                                </div>
                                            </div>
                                        ) : (
                                            <div className="space-y-4">
                                                <div className="flex gap-3">
                                                    <input type="time" value={workInput.entry} onChange={e => setWorkInput({...workInput, entry: e.target.value})} className={`flex-1 px-4 py-2 rounded-xl text-sm ${colors.input}`} />
                                                    <input type="time" value={workInput.exit} onChange={e => setWorkInput({...workInput, exit: e.target.value})} className={`flex-1 px-4 py-2 rounded-xl text-sm ${colors.input}`} />
                                                </div>
                                                <div className={`flex justify-between items-center ${colors.card} p-2 rounded-xl`}>
                                                    {MOODS.map(m => (
                                                        <button key={m.id} onClick={() => setWorkInput({...workInput, mood: m.id})} className={`p-1.5 rounded-full ${workInput.mood === m.id ? `${colors.surface} shadow-sm ${m.color}` : 'opacity-40 grayscale'}`}>
                                                            <i className={`ph-fill ${m.icon} text-3xl`}></i>
                                                        </button>
                                                    ))}
                                                </div>
                                                <Button colors={colors} variant="purple" onClick={() => {
                                                    if (workInput.entry && workInput.exit) { updateTodayLog('work', workInput); setWorkInput({ entry: '', exit: '', mood: 'ok' }); }
                                                }} className="w-full">Salvar Expediente</Button>
                                            </div>
                                        )}
                                    </Card>

                                    {/* Exerc√≠cio e Hobby */}
                                    <div className="grid grid-cols-2 gap-4">
                                        <Card colors={colors} className={`${colors.accent} bg-opacity-20 p-4`}>
                                            <div className="flex items-center gap-2 mb-4"><i className={`ph-fill ph-activity ${colors.accentText}`}></i><h3 className={`font-semibold ${colors.text}`}>Treino</h3></div>
                                            <div className="space-y-2 mb-4">
                                                <input placeholder="Ex: Caminhada" value={exerciseInput.type} onChange={e => setExerciseInput({...exerciseInput, type: e.target.value})} className={`w-full p-2 rounded-lg text-sm ${colors.input}`} />
                                                <div className="flex gap-2">
                                                    <input type="number" placeholder="Min" value={exerciseInput.duration} onChange={e => setExerciseInput({...exerciseInput, duration: e.target.value})} className={`w-1/2 p-2 rounded-lg text-sm ${colors.input}`} />
                                                    <input type="number" placeholder="Kcal" value={exerciseInput.calories} onChange={e => setExerciseInput({...exerciseInput, calories: e.target.value})} className={`w-1/2 p-2 rounded-lg text-sm ${colors.input}`} />
                                                </div>
                                                <Button colors={colors} variant="accent" onClick={() => {
                                                    if(exerciseInput.type && exerciseInput.duration) { updateTodayLog('exercises', [...todayLog.exercises, {type: exerciseInput.type, duration: parseInt(exerciseInput.duration), calories: parseInt(exerciseInput.calories||0)}]); setExerciseInput({type:'',duration:'',calories:''}); }
                                                }} className="w-full text-xs">Salvar</Button>
                                            </div>
                                            {todayLog.exercises.map((ex, i) => (
                                                <div key={i} className={`flex justify-between items-center ${colors.translucent} p-2 rounded-lg text-xs mt-2`}><span className={colors.textStrong}>{ex.type}</span><button onClick={() => updateTodayLog('exercises', todayLog.exercises.filter((_, idx) => idx !== i))} className="text-red-400"><i className="ph-bold ph-x"></i></button></div>
                                            ))}
                                        </Card>

                                        <Card colors={colors} className={`${colors.primary} bg-opacity-20 p-4`}>
                                            <div className="flex items-center gap-2 mb-4"><i className={`ph-fill ph-coffee ${colors.primaryText}`}></i><h3 className={`font-semibold ${colors.text}`}>Hobby</h3></div>
                                            <div className="space-y-2 mb-4">
                                                <input placeholder="Ex: Leitura" value={hobbyInput.type} onChange={e => setHobbyInput({...hobbyInput, type: e.target.value})} className={`w-full p-2 rounded-lg text-sm ${colors.input}`} />
                                                <input type="number" placeholder="Minutos" value={hobbyInput.duration} onChange={e => setHobbyInput({...hobbyInput, duration: e.target.value})} className={`w-full p-2 rounded-lg text-sm ${colors.input}`} />
                                                <Button colors={colors} variant="primary" onClick={() => {
                                                    if(hobbyInput.type && hobbyInput.duration) { updateTodayLog('hobbies', [...todayLog.hobbies, {type: hobbyInput.type, duration: parseInt(hobbyInput.duration)}]); setHobbyInput({type:'',duration:''}); }
                                                }} className="w-full text-xs">Salvar</Button>
                                            </div>
                                            {todayLog.hobbies.map((hb, i) => (
                                                <div key={i} className={`flex justify-between items-center ${colors.translucent} p-2 rounded-lg text-xs mt-2`}><span className={colors.textStrong}>{hb.type}</span><button onClick={() => updateTodayLog('hobbies', todayLog.hobbies.filter((_, idx) => idx !== i))} className="text-red-400"><i className="ph-bold ph-x"></i></button></div>
                                            ))}
                                        </Card>
                                    </div>
                                </div>
                            )}

                            {/* --- ESTAT√çSTICAS --- */}
                            {activeTab === 'stats' && (
                                <div className="space-y-6 animate-in">
                                    <h1 className={`text-3xl font-bold ${colors.text} font-serif mb-6`}>Estat√≠sticas</h1>
                                    <div className="flex gap-2 overflow-x-auto pb-2 scrollbar-hide">
                                        {[1, 3, 7, 15, 30].map(days => (
                                            <button key={days} onClick={() => setStatsPeriod(days)} className={`px-4 py-2 rounded-full text-sm font-bold ${statsPeriod === days ? `${colors.primary} ${colors.primaryText}` : `${colors.card} ${colors.textLight} border ${colors.border}`}`}>
                                                {days === 1 ? 'Hoje' : `${days} Dias`}
                                            </button>
                                        ))}
                                    </div>
                                    <div className="grid grid-cols-2 gap-4">
                                        <Card colors={colors} className="col-span-2 flex justify-between items-center">
                                            <div><p className={`text-sm ${colors.textLight}`}>Humor Predominante</p><h3 className={`text-xl font-bold ${colors.textStrong}`}>{statsPeriod === 1 ? 'Hoje' : `√öltimos ${statsPeriod} dias`}</h3></div>
                                            <div className={`p-4 rounded-full ${colors.yellow} bg-opacity-30`}><i className={`ph-fill ${stats.topMood.icon} ${stats.topMood.color} text-4xl`}></i></div>
                                        </Card>
                                        <Card colors={colors} className="flex flex-col items-center text-center gap-2">
                                            <i className={`ph-fill ph-pill ${colors.blueText} text-3xl`}></i>
                                            <p className={`text-sm ${colors.textLight}`}>Rem√©dios</p>
                                            <p className={`text-2xl font-bold ${colors.textStrong}`}>{stats.medAdherence}%</p>
                                        </Card>
                                        <Card colors={colors} className="flex flex-col items-center text-center gap-2">
                                            <i className="ph-fill ph-moon text-indigo-400 text-3xl"></i>
                                            <p className={`text-sm ${colors.textLight}`}>Sono</p>
                                            <p className={`text-2xl font-bold ${colors.indigoText}`}>{stats.avgSleep}h</p>
                                        </Card>
                                        <Card colors={colors} className={`col-span-2 ${colors.purpleCard}`}>
                                            <h3 className={`font-semibold ${colors.text} flex items-center gap-2`}><i className={`ph-fill ph-briefcase ${colors.purpleText}`}></i> Trabalho Total</h3>
                                            <p className={`text-2xl font-bold ${colors.purpleText} mt-2`}>{Math.floor(stats.totalWorkMins/60)}h {stats.totalWorkMins%60}m</p>
                                        </Card>
                                        <Card colors={colors} className="col-span-2">
                                            <h3 className={`font-semibold ${colors.text} flex items-center gap-2 mb-4`}><i className="ph-fill ph-activity"></i> Esfor√ßo F√≠sico</h3>
                                            <div className="flex gap-4"><div className="flex-1"><p className={`text-xs ${colors.textLight}`}>Minutos</p><p className={`text-xl font-bold ${colors.accentText}`}>{stats.totalExMins}</p></div><div className="flex-1"><p className={`text-xs ${colors.textLight}`}>Calorias</p><p className="text-xl font-bold text-orange-500">{stats.totalExCals}</p></div></div>
                                        </Card>
                                    </div>
                                </div>
                            )}

                            {/* --- CALEND√ÅRIO --- */}
                            {activeTab === 'calendar' && (
                                <div className="space-y-6 animate-in">
                                    <h1 className={`text-3xl font-bold ${colors.text} font-serif mb-6`}>O meu Hist√≥rico</h1>
                                    <Card colors={colors} className="p-4">
                                        <div className="flex justify-between items-center mb-6">
                                            <button onClick={() => setViewingMonth(new Date(currentYear, currentMonthIndex - 1, 1))} className={`p-2 ${colors.surface} rounded-full`}><i className="ph-bold ph-caret-left"></i></button>
                                            <h2 className={`font-bold ${colors.textStrong}`}>{MONTHS[currentMonthIndex]} {currentYear}</h2>
                                            <button onClick={() => setViewingMonth(new Date(currentYear, currentMonthIndex + 1, 1))} className={`p-2 ${colors.surface} rounded-full`}><i className="ph-bold ph-caret-right"></i></button>
                                        </div>
                                        <div className="grid grid-cols-7 gap-y-2 text-center">
                                            {WEEKDAYS.map(day => <div key={day} className={`text-xs font-bold ${colors.textLight} py-2`}>{day}</div>)}
                                            {blanks.map(blank => <div key={`blank-${blank}`} className="w-8 h-8"></div>)}
                                            {monthDays.map(day => {
                                                const dateStr = `${currentYear}-${String(currentMonthIndex + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                                                const hasData = logs[dateStr] && Object.keys(logs[dateStr]).length > 0;
                                                const isSel = selectedHistoryDate === dateStr;
                                                return (
                                                    <button key={day} onClick={() => setSelectedHistoryDate(dateStr)} className={`w-8 h-8 mx-auto flex flex-col items-center justify-center rounded-xl font-bold text-sm ${isSel ? `${colors.primary} ${colors.primaryText}` : `${colors.text} hover:${colors.surfaceHover}`}`}>
                                                        {day}
                                                        {hasData && <span className={`w-1 h-1 rounded-full mt-0.5 ${isSel ? 'bg-[#4A6B5D]' : 'bg-stone-300'}`}></span>}
                                                    </button>
                                                )
                                            })}
                                        </div>
                                    </Card>

                                    <div className="mt-8">
                                        <h3 className={`text-lg font-bold ${colors.text} mb-4`}><i className="ph-fill ph-calendar"></i> {selectedHistoryDate}</h3>
                                        {logs[selectedHistoryDate] && Object.keys(logs[selectedHistoryDate]).length > 0 ? (
                                            <div className="space-y-4">
                                                {logs[selectedHistoryDate].moods?.length > 0 && (
                                                    <Card colors={colors} className={`p-4 ${colors.surface}`}>
                                                        <h4 className={`font-bold text-sm ${colors.textStrong} mb-3`}>Humor</h4>
                                                        <div className="flex gap-2 flex-wrap">
                                                            {logs[selectedHistoryDate].moods.map((m, i) => <div key={i} className={`flex items-center gap-1 ${colors.card} px-3 py-1 rounded-full text-xs shadow-sm border ${colors.border}`}><i className={`ph-fill ${MOODS.find(x=>x.id===m.mood)?.icon} ${MOODS.find(x=>x.id===m.mood)?.color}`}></i> {m.time}</div>)}
                                                        </div>
                                                    </Card>
                                                )}
                                            </div>
                                        ) : (
                                            <p className={`text-center ${colors.textMuted} text-sm py-8`}>Nenhum registo neste dia.</p>
                                        )}
                                    </div>
                                </div>
                            )}
                        </div>

                        {/* --- NAVEGA√á√ÉO INFERIOR --- */}
                        <div className={`absolute bottom-0 w-full ${colors.bottomNav} backdrop-blur-lg border-t px-6 py-4 pb-8 flex justify-around`}>
                            <button onClick={() => setActiveTab('home')} className={`p-3 rounded-2xl flex flex-col items-center gap-1 ${activeTab === 'home' ? `${colors.primary} ${colors.primaryText}` : colors.textLight}`}><i className="ph-fill ph-house text-2xl"></i></button>
                            <button onClick={() => setActiveTab('calendar')} className={`p-3 rounded-2xl flex flex-col items-center gap-1 ${activeTab === 'calendar' ? `${colors.primary} ${colors.primaryText}` : colors.textLight}`}><i className="ph-fill ph-calendar-blank text-2xl"></i></button>
                            <button onClick={() => setActiveTab('stats')} className={`p-3 rounded-2xl flex flex-col items-center gap-1 ${activeTab === 'stats' ? `${colors.primary} ${colors.primaryText}` : colors.textLight}`}><i className="ph-fill ph-chart-bar text-2xl"></i></button>
                        </div>

                        {/* Notifica√ß√µes App */}
                        <div className="absolute top-4 w-full px-4 z-50 flex flex-col gap-2 pointer-events-none">
                            {notifications.map(n => (
                                <div key={n.id} className={`${colors.notification} p-4 rounded-2xl flex items-center justify-between border shadow-lg pointer-events-auto animate-in`}>
                                    <div className="flex gap-3 items-center"><i className="ph-fill ph-bell text-blue-500 text-xl"></i><p className={`text-sm font-bold ${colors.textStrong}`}>{n.msg}</p></div>
                                    <button onClick={() => setNotifications(notifications.filter(x => x.id !== n.id))} className={colors.textLight}><i className="ph-bold ph-x"></i></button>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>


